<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicFix - Smart Road Monitoring</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React and Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for Webkit */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, MapPin, Send, AlertTriangle, CheckCircle, Clock, ThumbsUp, 
            MessageSquare, X, Upload, BarChart2, Activity, Hash, ChevronRight, 
            Eye, Check, Trophy, Star, TrendingUp, AlertOctagon, Landmark, 
            Navigation, Globe, Map, Sparkles, FileText, List, ChevronDown 
        } from 'lucide-react';

        // Firebase Imports
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithCustomToken, 
            signInAnonymously, 
            onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            onSnapshot, 
            serverTimestamp
        } from 'firebase/firestore';

        // --- Firebase Initialization ---
        // Handle environment variables or fallbacks for standalone use
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, auth, db;
        
        const firebaseConfig = {
  apiKey: "AIzaSyAqIsVhv0N_V_z3ENsYZz76sRQfYlwIrkM",
  authDomain: "civicfix-fbfcc.firebaseapp.com",
  projectId: "civicfix-fbfcc",
  storageBucket: "civicfix-fbfcc.firebasestorage.app",
  messagingSenderId: "291507757806",
  appId: "1:291507757806:web:0bfcffd778b8e1488c09ff"
};
        const app = initializeApp(firebaseConfig);

        // --- Static Data ---
        const locationData = {
            "Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Sri Potti Sriramulu Nellore", "Visakhapatnam", "Vizianagaram", "West Godavari", "YSR District, Kadapa (Cuddapah)"],
            "Karnataka": ["Bagalkot", "Bangalore Rural", "Bangalore Urban", "Belgaum", "Bellary", "Bidar", "Bijapur", "Chamarajanagar", "Chikkaballapur", "Chikmagalur", "Chitradurga", "Dakshina Kannada", "Davangere", "Dharwad", "Gadag", "Gulbarga", "Hassan", "Haveri", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysore", "Raichur", "Ramanagara", "Shimoga", "Tumkur", "Udupi", "Uttara Kannada", "Yadgir"],
            "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"],
            "Tamil Nadu": ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"],
            "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"]
        };

        const stateGovtMap = {
            "Karnataka": { party: "People's Progressive Party", color: "text-green-400" },
            "Maharashtra": { party: "United Alliance Front", color: "text-orange-400" },
            "Delhi": { party: "Capital Care Party", color: "text-blue-400" },
            "Tamil Nadu": { party: "Southern League", color: "text-yellow-400" },
            "Uttar Pradesh": { party: "Janata Vikas", color: "text-red-400" }
        };

        // --- Components ---

        const ProgressBar = React.memo(({ status }) => {
            const steps = ['Reported', 'In Progress', 'Resolved'];
            const currentStep = status === 'Pending' ? 0 : status === 'In Progress' ? 1 : 2;

            return (
              <div className="w-full mt-4">
                <div className="flex justify-between mb-2">
                  {steps.map((step, index) => (
                    <div key={step} className={`text-xs font-semibold ${index <= currentStep ? 'text-blue-400' : 'text-gray-600'}`}>
                      {step}
                    </div>
                  ))}
                </div>
                <div className="h-2 bg-gray-700 rounded-full overflow-hidden flex">
                  {steps.map((step, index) => (
                    <div 
                      key={index} 
                      className={`h-full flex-1 border-r border-gray-800 last:border-0 transition-all duration-500 ${
                        index <= currentStep ? (index === 2 ? 'bg-green-500' : 'bg-blue-500') : 'bg-gray-700'
                      }`} 
                    />
                  ))}
                </div>
              </div>
            );
        });

        const FeedCard = React.memo(({ report, onUpvote }) => {
          return (
            <div className="bg-gray-800 rounded-2xl shadow-lg border border-gray-700 overflow-hidden flex flex-col fade-in">
              <div className="px-6 py-3 bg-gray-750 border-b border-gray-700 flex justify-between items-center">
                 <span className="bg-gray-900 text-gray-400 text-xs font-mono py-1 px-2 rounded border border-gray-700 flex items-center">
                   <Hash size={10} className="mr-1"/> {report.id}
                 </span>
                 <div className="text-right">
                   <span className="text-xs text-white block font-bold">{report.district}</span>
                   <span className="text-xs text-gray-500 block">{report.state}</span>
                 </div>
              </div>

              <div className="h-48 relative overflow-hidden group bg-gray-900">
                {report.status === 'Resolved' && report.proofImage ? (
                  <div className="flex h-full w-full">
                    <div className="w-1/2 relative border-r border-white/20">
                      <img src={report.image} className="w-full h-full object-cover" alt="Before" loading="lazy" />
                      <div className="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded">BEFORE</div>
                    </div>
                    <div className="w-1/2 relative">
                      <img src={report.proofImage} className="w-full h-full object-cover" alt="After" loading="lazy" />
                      <div className="absolute top-2 left-2 bg-green-600 text-white text-[10px] px-2 py-1 rounded font-bold">FIXED</div>
                    </div>
                  </div>
                ) : (
                  <img 
                    src={report.image} 
                    alt="Report" 
                    className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition duration-500"
                    loading="lazy"
                  />
                )}
                
                {report.status !== 'Resolved' && (
                   <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-gray-900 to-transparent p-4">
                      <span className="text-white font-bold text-lg drop-shadow-md">{report.category}</span>
                   </div>
                )}
              </div>
              
              <div className="p-6 flex-1 flex flex-col">
                <h3 className="font-semibold text-gray-200 mb-1 flex items-center justify-between">
                  <span className="truncate pr-2">{report.area}</span>
                  {report.coordinates && (
                    <a 
                      href={`https://www.google.com/maps/search/?api=1&query=${report.coordinates.lat},${report.coordinates.lng}`} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="text-blue-500 hover:text-blue-400 bg-blue-900/30 p-1.5 rounded-lg transition"
                      title="View Exact Location on Maps"
                    >
                      <MapPin size={16} />
                    </a>
                  )}
                </h3>
                <p className="text-gray-400 text-sm mb-4 line-clamp-2">
                  {report.description}
                </p>
                
                <div className="mt-auto">
                  <ProgressBar status={report.status} />
                </div>
                
                <div className="pt-4 mt-4 border-t border-gray-700 flex items-center justify-between">
                  <button 
                    onClick={() => onUpvote(report.firestoreId, report.upvotes)}
                    className="flex items-center space-x-2 text-gray-400 hover:text-blue-400 transition"
                  >
                    <ThumbsUp size={18} />
                    <span className="text-sm font-medium">{report.upvotes}</span>
                  </button>
                  <span className="text-xs text-gray-500 flex items-center">
                    <Clock size={12} className="mr-1" /> {report.timestamp}
                  </span>
                </div>
              </div>
            </div>
          );
        });

        const AdminRow = React.memo(({ report, onStatusUpdate, onVerifyStart }) => {
          return (
            <tr className="hover:bg-gray-750 transition">
              <td className="p-4 font-mono text-blue-400 text-sm">{report.id}</td>
              <td className="p-4">
                <div className="text-gray-300 font-bold text-sm">{report.district}</div>
                <div className="text-gray-500 text-xs">{report.state}</div>
              </td>
              <td className="p-4 text-gray-300">{report.category}</td>
              <td className="p-4">
                <div className="flex items-center text-orange-500 font-bold">
                  <Activity size={14} className="mr-1" />
                  {report.upvotes}
                </div>
              </td>
              <td className="p-4">
                 <span className={`px-2 py-1 rounded-full text-xs border ${
                  report.status === 'Resolved' ? 'bg-green-900/30 text-green-400 border-green-800' :
                  report.status === 'In Progress' ? 'bg-yellow-900/30 text-yellow-400 border-yellow-800' :
                  'bg-red-900/30 text-red-400 border-red-800'
                }`}>
                  {report.status}
                </span>
              </td>
              <td className="p-4">
                <div className="flex space-x-2">
                  {report.status === 'Resolved' ? (
                     <span className="flex items-center text-green-500 text-xs font-bold">
                       <CheckCircle size={14} className="mr-1" /> Verified
                     </span>
                  ) : (
                    <>
                      <button 
                        onClick={() => onStatusUpdate(report.firestoreId, 'In Progress')}
                        className="text-gray-400 hover:text-white border border-gray-600 px-3 py-1 rounded text-xs transition"
                        disabled={report.status === 'In Progress'}
                      >
                        Accept
                      </button>
                      <button 
                        onClick={() => onVerifyStart(report.firestoreId)}
                        className="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-500 flex items-center shadow-lg shadow-green-900/20"
                      >
                        <Upload size={12} className="mr-1" /> Verify & Close
                      </button>
                    </>
                  )}
                </div>
              </td>
            </tr>
          );
        });

        // Helper: Compress Image
        const compressImage = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL(file.type, 0.7)); 
              };
              img.onerror = (error) => reject(error);
            };
            reader.onerror = (error) => reject(error);
          });
        };

        const SmartRoadMonitoring = () => {
          const [activeTab, setActiveTab] = useState('home'); 
          const apiKey = ""; 

          const [user, setUser] = useState(null);
          const [reports, setReports] = useState([]);
          const [loadingData, setLoadingData] = useState(true);
          const [visibleCount, setVisibleCount] = useState(9);
          const [adminVisibleCount, setAdminVisibleCount] = useState(20);

          // Auth & Data
          useEffect(() => {
            if (!auth) {
                // Mock user for offline mode/demo
                if (!app) {
                    setUser({ uid: 'demo-user' });
                    setReports([
                        { id: 'DEMO-1', district: 'Bangalore Urban', state: 'Karnataka', area: 'Indiranagar', category: 'Pothole', upvotes: 5, status: 'Pending', image: 'https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800', timestamp: '10m ago' }
                    ]);
                    setLoadingData(false);
                }
                return;
            }

            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (error) {
                console.error("Auth failed", error);
              }
            };
            initAuth();
            
            const unsubscribe = onAuthStateChanged(auth, setUser);
            return () => unsubscribe();
          }, []);

          useEffect(() => {
            if (!user || !db) return;

            const reportsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
            
            const unsubscribe = onSnapshot(reportsCollection, (snapshot) => {
              const fetchedReports = snapshot.docs.map(doc => ({
                ...doc.data(),
                firestoreId: doc.id
              }));
              
              fetchedReports.sort((a, b) => {
                const tA = a.createdAt?.seconds || 0;
                const tB = b.createdAt?.seconds || 0;
                return tB - tA;
              });

              setReports(fetchedReports);
              setLoadingData(false);
            }, (error) => {
              console.error("Error fetching reports:", error);
              setLoadingData(false);
            });

            return () => unsubscribe();
          }, [user]);

          useEffect(() => {
            setVisibleCount(9);
            setAdminVisibleCount(20);
          }, [activeTab]);

          const [resolvingId, setResolvingId] = useState(null);
          const [proofImage, setProofImage] = useState(null); 
          const [isManualState, setIsManualState] = useState(false);
          const [isManualDistrict, setIsManualDistrict] = useState(false);

          const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
          const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
          const [imageBase64, setImageBase64] = useState(null);
          const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);
          const [aiSummary, setAiSummary] = useState(null);

          const stats = useMemo(() => {
            const areaCounts = {};
            const categoryCounts = {};
            const districtStats = {};
            const stateStats = {};

            reports.forEach(r => {
              areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
              categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;

              const districtKey = `${r.district}, ${r.state}`;
              if (!districtStats[districtKey]) {
                districtStats[districtKey] = { name: r.district, state: r.state, total: 0, resolved: 0 };
              }
              districtStats[districtKey].total += 1;
              
              if (!stateStats[r.state]) {
                stateStats[r.state] = { name: r.state, total: 0, resolved: 0 };
              }
              stateStats[r.state].total += 1;

              if (r.status === 'Resolved') {
                districtStats[districtKey].resolved += 1;
                stateStats[r.state].resolved += 1;
              }
            });

            const sortedAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]);
            const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);

            const districtRankings = Object.values(districtStats).map(d => ({
              ...d,
              ratio: d.total > 0 ? (d.resolved / d.total) * 100 : 0
            })).sort((a, b) => b.ratio - a.ratio); 

            const stateRankings = Object.values(stateStats).map(state => ({
              ...state,
              ratio: state.total > 0 ? (state.resolved / state.total) * 100 : 0,
              govt: stateGovtMap[state.name] || { party: "Independent", color: "text-gray-400" }
            })).sort((a, b) => b.ratio - a.ratio);

            return { sortedAreas, sortedCategories, districtRankings, stateRankings };
          }, [reports]);

          const [newReport, setNewReport] = useState({
            state: 'Karnataka',
            district: 'Bangalore Urban',
            area: '',
            location: '',
            coordinates: null, 
            category: 'Pothole',
            description: '',
            image: null
          });

          const handleFileChange = async (e, setFunction, currentObj) => {
            const file = e.target.files[0];
            if (file) {
              try {
                const compressedBase64 = await compressImage(file);
                const rawBase64 = compressedBase64.split(',')[1];
                setImageBase64(rawBase64);
                
                if (currentObj) {
                   setFunction({ ...currentObj, image: compressedBase64 });
                } else {
                   setFunction(compressedBase64);
                }
              } catch (err) {
                console.error("Compression error:", err);
                alert("Error processing image. Please try another.");
              }
            }
          };

          const analyzeImageWithGemini = async () => {
            if (!imageBase64) {
              alert("Please upload an image first.");
              return;
            }
            
            setIsAnalyzingImage(true);
            setAiAnalysisResult(null);

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{
                    role: "user",
                    parts: [
                      { text: "Identify the road infrastructure issue in this image. Categorize it as one of: Pothole, Street Light, Road Crack, Broken Signal, Faded Markings, Damaged Manhole, Missing Signage. Provide a short, professional description for a civic complaint. Return valid JSON only with keys: 'category' and 'description'." },
                      { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }
                    ]
                  }],
                  generationConfig: {
                    responseMimeType: "application/json"
                  }
                })
              });

              const data = await response.json();
              const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
              
              if (resultText) {
                const result = JSON.parse(resultText);
                setNewReport(prev => ({
                  ...prev,
                  category: result.category || prev.category,
                  description: result.description || prev.description
                }));
                setAiAnalysisResult("Auto-filled by AI âœ¨");
              }
            } catch (error) {
              console.error("Gemini Analysis Error:", error);
              alert("AI analysis failed. Please enter details manually.");
            } finally {
              setIsAnalyzingImage(false);
            }
          };

          const generateInsightsWithGemini = async () => {
            setIsGeneratingSummary(true);
            setAiSummary(null);

            const dataContext = `
              Top Issues: ${JSON.stringify(stats.sortedCategories.slice(0, 3))}
              State Performance: ${JSON.stringify(stats.stateRankings.map(s => ({name: s.name, ratio: s.ratio})))}
            `;

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{
                    parts: [{ text: `Act as a civic data analyst. Analyze this road issue data: ${dataContext}. Write a 3-bullet point executive summary for the City Commissioner. Use emojis.` }]
                  }]
                })
              });

              const data = await response.json();
              const summary = data.candidates?.[0]?.content?.parts?.[0]?.text;
              setAiSummary(summary);
            } catch (error) {
              console.error("Gemini Summary Error:", error);
              alert("Could not generate summary.");
            } finally {
              setIsGeneratingSummary(false);
            }
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!user) { alert("Please wait for initialization."); return; }
            if (!db) { alert("Database not connected."); return; }

            const report = {
              id: `WRD-${Math.floor(Math.random() * 90) + 10}-${Math.floor(Math.random() * 9000) + 1000}`,
              state: newReport.state || "Unknown",
              district: newReport.district || "Unknown",
              area: newReport.area,
              location: newReport.location,
              coordinates: newReport.coordinates,
              category: newReport.category,
              description: newReport.description,
              status: "Pending",
              upvotes: 0,
              createdAt: serverTimestamp(),
              timestamp: "Just now",
              image: newReport.image || "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
              proofImage: null,
              comments: []
            };

            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), report);
              setNewReport({ state: 'Karnataka', district: 'Bangalore Urban', area: '', location: '', coordinates: null, category: 'Pothole', description: '', image: null });
              setActiveTab('feed');
            } catch (err) {
              console.error("Error saving report:", err);
            }
          };

          const updateStatus = useCallback(async (docId, newStatus) => {
            if (!docId || !user || !db) return;
            try {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', docId);
              await updateDoc(docRef, { status: newStatus });
            } catch (err) { console.error("Update failed", err); }
          }, [user]);

          const submitResolution = async () => {
            if (!proofImage) { alert("Please upload a photo of the fixed road."); return; }
            if (!resolvingId || !user || !db) return;
            try {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', resolvingId);
              await updateDoc(docRef, { status: 'Resolved', proofImage: proofImage });
              setResolvingId(null);
              setProofImage(null);
            } catch (err) { console.error("Resolution submit failed", err); }
          };

          const handleUpvote = useCallback(async (docId, currentUpvotes) => {
            if (!docId || !user || !db) return;
            try {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', docId);
              await updateDoc(docRef, { upvotes: currentUpvotes + 1 });
            } catch (err) { console.error("Upvote failed", err); }
          }, [user]);

          return (
            <div className="min-h-screen bg-gray-900 font-sans text-gray-100 pb-20">
              
              {/* Modal */}
              {resolvingId && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                  <div className="bg-gray-800 rounded-2xl w-full max-w-md p-6 border border-gray-700 shadow-2xl">
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-bold text-white">Close Ticket</h3>
                      <button onClick={() => {setResolvingId(null); setProofImage(null);}} className="text-gray-400 hover:text-white">
                        <X />
                      </button>
                    </div>
                    <div className="space-y-4">
                      <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center bg-gray-700/50 relative">
                        <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, setProofImage, null)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        {proofImage ? ( <img src={proofImage} alt="Proof" className="h-40 w-full object-cover rounded-lg mx-auto" /> ) : ( <div className="flex flex-col items-center"><Upload className="text-blue-400 mb-2" size={32} /><p className="text-blue-300 font-medium">Upload Proof</p></div> )}
                      </div>
                      <button onClick={submitResolution} className={`w-full py-3 rounded-xl font-bold transition ${proofImage ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-gray-700 text-gray-500'}`} disabled={!proofImage}>Verify & Close</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Navbar */}
              <nav className="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between h-16 items-center">
                    <div className="flex items-center cursor-pointer" onClick={() => setActiveTab('home')}>
                      <div className="bg-blue-600 p-2 rounded-lg mr-2"><MapPin className="text-white" size={24} /></div>
                      <span className="font-bold text-xl tracking-tight text-white">CivicFix</span>
                    </div>
                    <div className="hidden md:flex space-x-8">
                      {['home', 'feed', 'stats', 'admin'].map((tab) => (
                        <button key={tab} onClick={() => setActiveTab(tab)} className={`capitalize ${activeTab === tab ? 'text-blue-400 font-bold' : 'text-gray-400 hover:text-white'}`}>{tab === 'feed' ? 'Dashboard' : tab === 'stats' ? 'Analytics' : tab === 'admin' ? 'Official' : tab}</button>
                      ))}
                    </div>
                    <button onClick={() => setActiveTab('report')} className="bg-blue-600 text-white px-5 py-2 rounded-full font-medium shadow-lg hover:bg-blue-500 transition flex items-center"><Camera size={18} className="mr-2" /> Report</button>
                  </div>
                </div>
              </nav>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {activeTab === 'home' && (
                  <div className="space-y-16">
                    <section className="text-center py-20 px-4">
                      <h1 className="text-5xl font-extrabold text-white mb-6 leading-tight">CivicFix <br/><span className="text-blue-500">Smoother Journeys.</span></h1>
                      <div className="max-w-3xl mx-auto mb-10 bg-gradient-to-r from-blue-900/40 to-purple-900/40 border border-blue-500/30 p-6 rounded-2xl backdrop-blur-sm">
                        <p className="text-2xl font-serif italic text-blue-200 mb-2">"Your shutter can save a life."</p>
                      </div>
                      <div className="flex justify-center gap-4">
                        <button onClick={() => setActiveTab('report')} className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-500 transition">File Complaint</button>
                        <button onClick={() => setActiveTab('stats')} className="bg-gray-800 text-white border border-gray-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-700 transition">View Graphs</button>
                      </div>
                    </section>
                  </div>
                )}

                {activeTab === 'report' && (
                  <div className="max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-hidden">
                    <div className="bg-blue-600 p-6 text-white"><h2 className="text-2xl font-bold flex items-center"><AlertTriangle className="mr-3" /> New Report</h2></div>
                    <form onSubmit={handleSubmit} className="p-8 space-y-6">
                        <div className="space-y-4">
                             <div className="flex justify-between items-center"><label className="text-sm font-medium text-gray-300">Evidence</label>{newReport.image && (<button type="button" onClick={analyzeImageWithGemini} disabled={isAnalyzingImage} className="text-xs bg-purple-600/20 text-purple-300 border border-purple-500/50 px-3 py-1 rounded-full flex items-center">{isAnalyzingImage ? "Analyzing..." : "Auto-fill with Gemini"}</button>)}</div>
                             <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center bg-gray-700/50 relative">
                                <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, setNewReport, newReport)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required />
                                {newReport.image ? <img src={newReport.image} className="h-48 w-full object-cover rounded-lg" /> : <div className="flex flex-col items-center"><Upload className="text-gray-400 mb-2" size={32} /><p className="text-gray-400 text-sm">Upload Photo</p></div>}
                             </div>
                        </div>
                        <div className="grid grid-cols-2 gap-6">
                            <input type="text" placeholder="State" className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white" value={newReport.state} onChange={(e) => setNewReport({...newReport, state: e.target.value})} />
                            <input type="text" placeholder="District" className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white" value={newReport.district} onChange={(e) => setNewReport({...newReport, district: e.target.value})} />
                        </div>
                        <input type="text" placeholder="Location" className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white" value={newReport.location} onChange={(e) => setNewReport({...newReport, location: e.target.value})} />
                        <textarea placeholder="Description" rows="3" className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white" value={newReport.description} onChange={(e) => setNewReport({...newReport, description: e.target.value})}></textarea>
                        <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-500 transition">Submit Report</button>
                    </form>
                  </div>
                )}

                {activeTab === 'stats' && (
                  <div className="space-y-8">
                     <div className="flex justify-between"><h2 className="text-3xl font-bold text-white">Analytics</h2><button onClick={generateInsightsWithGemini} disabled={isGeneratingSummary} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">{isGeneratingSummary ? "..." : "Generate Insights"}</button></div>
                     {aiSummary && <div className="bg-purple-900/20 border border-purple-500/30 p-6 rounded-2xl">{aiSummary}</div>}
                     <div className="grid md:grid-cols-2 gap-4">
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                             <h3 className="text-gray-400 mb-4">Top Issues</h3>
                             {stats.sortedCategories.slice(0,5).map(([cat, count], i) => (
                                 <div key={i} className="flex justify-between py-2 border-b border-gray-700 last:border-0"><span>{cat}</span><span className="font-bold text-white">{count}</span></div>
                             ))}
                        </div>
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                             <h3 className="text-gray-400 mb-4">State Performance</h3>
                             {stats.stateRankings.slice(0,5).map((s, i) => (
                                 <div key={i} className="flex justify-between py-2 border-b border-gray-700 last:border-0"><span>{s.name}</span><span className={s.ratio < 50 ? "text-red-400 font-bold" : "text-green-400 font-bold"}>{Math.round(s.ratio)}%</span></div>
                             ))}
                        </div>
                     </div>
                  </div>
                )}

                {activeTab === 'feed' && (
                  <div>
                    <h2 className="text-3xl font-bold text-white mb-8">Public Dashboard</h2>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {reports.slice(0, visibleCount).map((report) => <FeedCard key={report.id} report={report} onUpvote={handleUpvote} />)}
                    </div>
                    {visibleCount < reports.length && <button onClick={() => setVisibleCount(p => p+9)} className="block mx-auto mt-8 text-blue-400">Load More</button>}
                  </div>
                )}

                {activeTab === 'admin' && (
                  <div className="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-x-auto">
                    <table className="w-full text-left">
                        <thead><tr className="bg-gray-900 text-gray-400"><th className="p-4">ID</th><th className="p-4">Location</th><th className="p-4">Type</th><th className="p-4">Upvotes</th><th className="p-4">Status</th><th className="p-4">Action</th></tr></thead>
                        <tbody className="divide-y divide-gray-700">{reports.slice(0, adminVisibleCount).map((r) => <AdminRow key={r.id} report={r} onStatusUpdate={updateStatus} onVerifyStart={setResolvingId} />)}</tbody>
                    </table>
                  </div>
                )}
              </main>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SmartRoadMonitoring />);
    </script>
</body>
</html>
