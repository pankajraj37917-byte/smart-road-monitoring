import React, { useState, useMemo } from 'react';
import { Camera, MapPin, Send, AlertTriangle, CheckCircle, Clock, ThumbsUp, MessageSquare, X, Upload, BarChart2, Activity, Hash, ChevronRight, Eye, Check, Trophy, Star, TrendingUp, AlertOctagon, Landmark } from 'lucide-react';

const SmartRoadMonitoring = () => {
  const [activeTab, setActiveTab] = useState('home'); // home, report, feed, admin, stats
  
  // State for the Admin "Proof of Fix" Modal
  const [resolvingId, setResolvingId] = useState(null);
  const [proofImage, setProofImage] = useState(null);

  // Mappings for Cities to States and Governments (Mock Data)
  const cityToStateMap = {
    "Bangalore": "Karnataka",
    "Mumbai": "Maharashtra",
    "Pune": "Maharashtra",
    "Delhi": "Delhi",
    "Chennai": "Tamil Nadu"
  };

  const stateGovtMap = {
    "Karnataka": { party: "People's Progressive Party", color: "text-green-400" },
    "Maharashtra": { party: "United Alliance Front", color: "text-orange-400" },
    "Delhi": { party: "Capital Care Party", color: "text-blue-400" },
    "Tamil Nadu": { party: "Southern League", color: "text-yellow-400" }
  };

  // Enriched Data with Cities - ROAD PROBLEMS ONLY
  const [reports, setReports] = useState([
    {
      id: "WRD-45-1024",
      city: "Bangalore",
      area: "Indiranagar",
      location: "MG Road, 4th Block",
      category: "Pothole",
      description: "Huge pothole causing traffic slowdown.",
      status: "Resolved",
      upvotes: 45,
      timestamp: "2 hours ago",
      image: "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
      proofImage: "https://images.unsplash.com/photo-1584463635805-f673a4666dce?auto=format&fit=crop&q=80&w=800"
    },
    {
      id: "WRD-22-8991",
      city: "Mumbai",
      area: "Andheri West",
      location: "Link Road",
      category: "Street Light",
      description: "Street light broken and hanging dangerously low.",
      status: "In Progress",
      upvotes: 128,
      timestamp: "1 day ago",
      image: "https://images.unsplash.com/photo-1566041510394-cf7c8d968a4e?auto=format&fit=crop&q=80&w=800",
      proofImage: null
    },
    {
      id: "WRD-12-3321",
      city: "Delhi",
      area: "Sector 12",
      location: "Market Road",
      category: "Road Crack",
      description: "Longitudinal crack spreading across the lane.",
      status: "Resolved",
      upvotes: 89,
      timestamp: "3 days ago",
      image: "https://images.unsplash.com/photo-1626885375048-c2b64388e604?auto=format&fit=crop&q=80&w=800",
      proofImage: "https://images.unsplash.com/photo-1584463635805-f673a4666dce?auto=format&fit=crop&q=80&w=800"
    },
    {
      id: "WRD-45-1025",
      city: "Bangalore",
      area: "Indiranagar",
      location: "100ft Road",
      category: "Pothole",
      description: "Deep crater near the junction.",
      status: "Resolved",
      upvotes: 12,
      timestamp: "5 hours ago",
      image: "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
      proofImage: "https://images.unsplash.com/photo-1584463635805-f673a4666dce?auto=format&fit=crop&q=80&w=800"
    },
    {
      id: "WRD-45-1026",
      city: "Bangalore",
      area: "Koramangala",
      location: "80ft Road",
      category: "Faded Markings",
      description: "Zebra crossing completely invisible.",
      status: "Pending",
      upvotes: 34,
      timestamp: "6 hours ago",
      image: "https://images.unsplash.com/photo-1532996122724-e3c354a0b15b?auto=format&fit=crop&q=80&w=800",
      proofImage: null
    },
    {
      id: "WRD-99-4411",
      city: "Mumbai",
      area: "Bandra",
      location: "Hill Road",
      category: "Broken Signal",
      description: "Traffic light stuck on red.",
      status: "Pending",
      upvotes: 56,
      timestamp: "2 days ago",
      image: "https://images.unsplash.com/photo-1566041510394-cf7c8d968a4e?auto=format&fit=crop&q=80&w=800",
      proofImage: null
    },
    {
      id: "WRD-77-2211",
      city: "Pune",
      area: "Kothrud",
      location: "Paud Road",
      category: "Damaged Manhole",
      description: "Manhole cover slightly open and dangerous.",
      status: "Resolved",
      upvotes: 12,
      timestamp: "4 days ago",
      image: "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
      proofImage: "https://images.unsplash.com/photo-1584463635805-f673a4666dce?auto=format&fit=crop&q=80&w=800"
    }
  ]);

  // Analytics Logic with City Ranking & Government Performance
  const stats = useMemo(() => {
    const areaCounts = {};
    const categoryCounts = {};
    const cityStats = {};
    const stateStats = {};

    reports.forEach(r => {
      // Basic counts
      areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
      categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;

      // City Ranking Logic
      if (!cityStats[r.city]) {
        cityStats[r.city] = { name: r.city, total: 0, resolved: 0 };
      }
      cityStats[r.city].total += 1;
      
      // State Ranking Logic
      const stateName = cityToStateMap[r.city] || "Unknown";
      if (!stateStats[stateName]) {
        stateStats[stateName] = { name: stateName, total: 0, resolved: 0 };
      }
      stateStats[stateName].total += 1;

      if (r.status === 'Resolved') {
        cityStats[r.city].resolved += 1;
        stateStats[stateName].resolved += 1;
      }
    });

    const sortedAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]);
    const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);

    // Calculate Ratio and Sort Cities
    const cityRankings = Object.values(cityStats).map(city => ({
      ...city,
      ratio: city.total > 0 ? (city.resolved / city.total) * 100 : 0
    })).sort((a, b) => b.ratio - a.ratio); 

    // Calculate Ratio and Sort States (Governments)
    const stateRankings = Object.values(stateStats).map(state => ({
      ...state,
      ratio: state.total > 0 ? (state.resolved / state.total) * 100 : 0,
      govt: stateGovtMap[state.name] || { party: "Independent", color: "text-gray-400" }
    })).sort((a, b) => b.ratio - a.ratio);

    // Max values for graph scaling
    const maxAreaCount = Math.max(...Object.values(areaCounts), 1);

    return { sortedAreas, sortedCategories, maxAreaCount, cityRankings, stateRankings };
  }, [reports]);

  // Form State
  const [newReport, setNewReport] = useState({
    city: 'Bangalore',
    area: 'Indiranagar',
    location: '',
    category: 'Pothole',
    description: '',
    image: null
  });

  const handleFileChange = (e, setFunction, currentObj) => {
    const file = e.target.files[0];
    if (file) {
      if (currentObj) {
         setFunction({ ...currentObj, image: URL.createObjectURL(file) });
      } else {
         setFunction(URL.createObjectURL(file));
      }
    }
  };

  const generateUniqueId = () => {
    return `WRD-${Math.floor(Math.random() * 90) + 10}-${Math.floor(Math.random() * 9000) + 1000}`;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const report = {
      id: generateUniqueId(),
      city: newReport.city,
      area: newReport.area,
      location: newReport.location,
      category: newReport.category,
      description: newReport.description,
      status: "Pending",
      upvotes: 0,
      timestamp: "Just now",
      image: newReport.image || "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
      proofImage: null,
      comments: []
    };
    setReports([report, ...reports]);
    setNewReport({ city: 'Bangalore', area: 'Indiranagar', location: '', category: 'Pothole', description: '', image: null });
    setActiveTab('feed');
  };

  const updateStatus = (id, newStatus) => {
    const updatedReports = reports.map(report => 
      report.id === id ? { ...report, status: newStatus } : report
    );
    setReports(updatedReports);
  };

  const submitResolution = () => {
    if (!proofImage) {
      alert("Please upload a photo of the fixed road.");
      return;
    }
    const updatedReports = reports.map(report => 
      report.id === resolvingId ? { ...report, status: 'Resolved', proofImage: proofImage } : report
    );
    setReports(updatedReports);
    setResolvingId(null);
    setProofImage(null);
  };

  const handleUpvote = (id) => {
    const updatedReports = reports.map(report => 
      report.id === id ? { ...report, upvotes: report.upvotes + 1 } : report
    );
    setReports(updatedReports);
  };

  // Custom SVG Bar Chart Component
  const SimpleBarChart = ({ data, maxValue, color }) => {
    const chartHeight = 150;
    const barWidth = 40;
    const gap = 20;
    
    return (
      <svg width="100%" height={chartHeight + 40} className="overflow-visible">
        {data.map(([label, value], index) => {
          const barHeight = (value / maxValue) * chartHeight;
          const x = index * (barWidth + gap);
          const y = chartHeight - barHeight;
          
          return (
            <g key={label}>
              <rect 
                x={x} 
                y={y} 
                width={barWidth} 
                height={barHeight} 
                fill={color} 
                className="hover:opacity-80 transition-opacity cursor-pointer"
                rx="4"
              />
              <text 
                x={x + barWidth / 2} 
                y={y - 5} 
                textAnchor="middle" 
                fill="white" 
                fontSize="12" 
                fontWeight="bold"
              >
                {value}
              </text>
              <text 
                x={x + barWidth / 2} 
                y={chartHeight + 15} 
                textAnchor="middle" 
                fill="#9ca3af" 
                fontSize="10"
                style={{textTransform: 'capitalize'}}
              >
                {label.split(' ')[0]}
              </text>
            </g>
          );
        })}
        {/* Baseline */}
        <line x1="0" y1={chartHeight} x2="100%" y2={chartHeight} stroke="#4b5563" strokeWidth="1" />
      </svg>
    );
  };

  const ProgressBar = ({ status }) => {
    const steps = ['Reported', 'In Progress', 'Resolved'];
    const currentStep = status === 'Pending' ? 0 : status === 'In Progress' ? 1 : 2;

    return (
      <div className="w-full mt-4">
        <div className="flex justify-between mb-2">
          {steps.map((step, index) => (
            <div key={step} className={`text-xs font-semibold ${index <= currentStep ? 'text-blue-400' : 'text-gray-600'}`}>
              {step}
            </div>
          ))}
        </div>
        <div className="h-2 bg-gray-700 rounded-full overflow-hidden flex">
          {steps.map((step, index) => (
            <div 
              key={index} 
              className={`h-full flex-1 border-r border-gray-800 last:border-0 transition-all duration-500 ${
                index <= currentStep ? (index === 2 ? 'bg-green-500' : 'bg-blue-500') : 'bg-gray-700'
              }`} 
            />
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-900 font-sans text-gray-100">
      
      {/* Proof of Fix Modal */}
      {resolvingId && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
          <div className="bg-gray-800 rounded-2xl w-full max-w-md p-6 border border-gray-700 shadow-2xl">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-white">Close Ticket {resolvingId}</h3>
              <button onClick={() => {setResolvingId(null); setProofImage(null);}} className="text-gray-400 hover:text-white">
                <X />
              </button>
            </div>
            
            <p className="text-gray-400 mb-4 text-sm">
              To verify this resolution, you <span className="text-red-400 font-bold">must</span> upload a photo of the completed work.
            </p>

            <div className="space-y-4">
              <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center bg-gray-700/50 relative">
                <input 
                  type="file" 
                  accept="image/*"
                  onChange={(e) => handleFileChange(e, setProofImage, null)}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                {proofImage ? (
                  <img src={proofImage} alt="Proof" className="h-40 w-full object-cover rounded-lg mx-auto" />
                ) : (
                  <div className="flex flex-col items-center">
                    <Upload className="text-blue-400 mb-2" size={32} />
                    <p className="text-blue-300 font-medium">Upload Proof of Fix</p>
                  </div>
                )}
              </div>
              
              <button 
                onClick={submitResolution}
                className={`w-full py-3 rounded-xl font-bold transition ${proofImage ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}
                disabled={!proofImage}
              >
                Verify & Close Complaint
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Navigation */}
      <nav className="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <div className="flex items-center cursor-pointer" onClick={() => setActiveTab('home')}>
              <div className="bg-blue-600 p-2 rounded-lg mr-2">
                <MapPin className="text-white" size={24} />
              </div>
              <span className="font-bold text-xl tracking-tight text-white">Smart Road Monitoring</span>
            </div>
            
            {/* Desktop Menu */}
            <div className="hidden md:flex space-x-8">
              {['home', 'feed', 'stats', 'admin'].map((tab) => (
                <button 
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`capitalize ${activeTab === tab ? 'text-blue-400 font-bold' : 'text-gray-400 hover:text-white transition'}`}
                >
                  {tab === 'feed' ? 'Dashboard' : tab === 'stats' ? 'Analytics' : tab === 'admin' ? 'Official' : tab}
                </button>
              ))}
            </div>
            
            <button 
              onClick={() => setActiveTab('report')}
              className="bg-blue-600 text-white px-5 py-2 rounded-full font-medium shadow-lg hover:bg-blue-500 transition transform hover:-translate-y-0.5 flex items-center"
            >
              <Camera size={18} className="mr-2" /> Report Issue
            </button>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {/* HOME VIEW */}
        {activeTab === 'home' && (
          <div className="space-y-16">
            <section className="text-center py-20 px-4">
              <h1 className="text-5xl font-extrabold text-white mb-6 leading-tight">
                Smart Road Monitoring <br/>
                <span className="text-blue-500">Smoother Journeys.</span>
              </h1>
              
              {/* Inspirational Quote Section */}
              <div className="max-w-3xl mx-auto mb-10 bg-gradient-to-r from-blue-900/40 to-purple-900/40 border border-blue-500/30 p-6 rounded-2xl backdrop-blur-sm">
                <p className="text-2xl font-serif italic text-blue-200 mb-2">
                  "Your shutter can save a life."
                </p>
                <p className="text-lg text-gray-300 font-medium">
                  One Photo = One Accident Less.
                </p>
              </div>

              <p className="max-w-2xl mx-auto text-xl text-gray-400 mb-10">
                A transparent, public ledger for road infrastructure issues. Authorities must upload proof to close tickets.
              </p>
              <div className="flex justify-center gap-4">
                <button 
                  onClick={() => setActiveTab('report')}
                  className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/50 hover:bg-blue-500 transition"
                >
                  File Complaint
                </button>
                <button 
                  onClick={() => setActiveTab('stats')}
                  className="bg-gray-800 text-white border border-gray-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-700 transition"
                >
                  View Graphs
                </button>
              </div>
            </section>
            
            {/* Quick Stats Teaser */}
            <div className="grid md:grid-cols-3 gap-6">
              <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-gray-400 font-medium">Top Star City</h3>
                  <Star className="text-yellow-400 fill-yellow-400" />
                </div>
                <p className="text-3xl font-bold text-white">
                  {stats.cityRankings[0]?.name || "N/A"}
                </p>
                <p className="text-sm text-green-400 mt-2">
                  {Math.round(stats.cityRankings[0]?.ratio || 0)}% Efficiency
                </p>
              </div>
              <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-gray-400 font-medium">Top Road Issue</h3>
                  <AlertTriangle className="text-yellow-500" />
                </div>
                <p className="text-3xl font-bold text-white">{stats.sortedCategories[0]?.[0] || "N/A"}</p>
                <p className="text-sm text-yellow-400 mt-2">Needs Urgent Attention</p>
              </div>
              <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-gray-400 font-medium">Underperforming State</h3>
                  <AlertOctagon className="text-red-500" />
                </div>
                <p className="text-3xl font-bold text-white">
                  {stats.stateRankings[stats.stateRankings.length - 1]?.name || "N/A"}
                </p>
                <p className="text-sm text-red-400 mt-2">
                  Action Required
                </p>
              </div>
            </div>
          </div>
        )}

        {/* REPORT VIEW */}
        {activeTab === 'report' && (
          <div className="max-w-2xl mx-auto">
            <div className="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-hidden">
              <div className="bg-blue-600 p-6 text-white">
                <h2 className="text-2xl font-bold flex items-center">
                  <AlertTriangle className="mr-3" /> New Road Report
                </h2>
                <p className="text-blue-100 mt-2">Your ID will be generated upon submission.</p>
              </div>
              
              <form onSubmit={handleSubmit} className="p-8 space-y-6">
                
                <div className="grid grid-cols-2 gap-6">
                   <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">City</label>
                    <select 
                      className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newReport.city}
                      onChange={(e) => setNewReport({...newReport, city: e.target.value})}
                    >
                      <option>Bangalore</option>
                      <option>Mumbai</option>
                      <option>Delhi</option>
                      <option>Pune</option>
                      <option>Chennai</option>
                    </select>
                  </div>
                   <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">Area / Ward</label>
                    <input 
                      type="text"
                      placeholder="e.g. Indiranagar"
                      className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newReport.area}
                      onChange={(e) => setNewReport({...newReport, area: e.target.value})}
                      required
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">Problem Type</label>
                    <select 
                      className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newReport.category}
                      onChange={(e) => setNewReport({...newReport, category: e.target.value})}
                    >
                      <option>Pothole</option>
                      <option>Street Light</option>
                      <option>Road Crack</option>
                      <option>Broken Signal</option>
                      <option>Faded Markings</option>
                      <option>Damaged Manhole</option>
                      <option>Missing Signage</option>
                    </select>
                  </div>
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">Specific Location</label>
                    <input 
                      type="text" 
                      placeholder="e.g. Near HDFC Bank"
                      className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newReport.location}
                      onChange={(e) => setNewReport({...newReport, location: e.target.value})}
                      required
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="block text-sm font-medium text-gray-300">Description</label>
                  <textarea 
                    placeholder="Describe the road issue..."
                    rows="4"
                    className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                    value={newReport.description}
                    onChange={(e) => setNewReport({...newReport, description: e.target.value})}
                    required
                  ></textarea>
                </div>

                 {/* Image Upload Area */}
                 <div className="space-y-2">
                  <label className="block text-sm font-medium text-gray-300">Evidence</label>
                  <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center hover:bg-gray-750 transition cursor-pointer relative bg-gray-700/50">
                    <input 
                      type="file" 
                      accept="image/*"
                      onChange={(e) => handleFileChange(e, setNewReport, newReport)}
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                      required
                    />
                    {newReport.image ? (
                      <div className="relative h-48 w-full">
                        <img src={newReport.image} alt="Preview" className="h-full w-full object-cover rounded-lg" />
                      </div>
                    ) : (
                      <div className="flex flex-col items-center">
                        <Upload className="text-gray-400 mb-2" size={32} />
                        <p className="text-gray-400 text-sm">Upload Photo</p>
                      </div>
                    )}
                  </div>
                </div>

                <button 
                  type="submit" 
                  className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-500 shadow-lg transition"
                >
                  Generate Official Report
                </button>
              </form>
            </div>
          </div>
        )}

        {/* ANALYTICS/STATS VIEW - GRAPH UPDATE */}
        {activeTab === 'stats' && (
          <div className="space-y-8">
            <h2 className="text-3xl font-bold text-white flex items-center">
              <BarChart2 className="mr-3 text-blue-500" /> Graphical Analysis
            </h2>
            
             {/* New State Governance Report Card */}
             <div className="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl">
               <h3 className="text-2xl font-bold text-white mb-6 flex items-center">
                 <Landmark className="mr-3 text-purple-500" /> State Governance Tracker
                 <span className="ml-3 text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full border border-purple-500/30">
                   Resolution Efficiency by Ruling Government
                 </span>
               </h3>

               <div className="grid grid-cols-1 gap-4">
                 {stats.stateRankings.map((state, index) => {
                   const isCritical = state.ratio < 50;
                   return (
                     <div key={state.name} className={`p-5 rounded-xl border transition flex flex-col md:flex-row items-center justify-between ${isCritical ? 'bg-red-900/10 border-red-500/50' : 'bg-gray-700/30 border-gray-700'}`}>
                       
                       <div className="flex items-center mb-4 md:mb-0 w-full md:w-1/3">
                         <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg mr-4 bg-gray-700 text-gray-300`}>
                           {index + 1}
                         </div>
                         <div>
                           <h4 className="font-bold text-lg text-white">{state.name}</h4>
                           <p className={`text-sm font-semibold ${state.govt.color}`}>{state.govt.party}</p>
                         </div>
                       </div>

                       {/* Status Banner */}
                       <div className="w-full md:w-1/3 flex justify-center mb-4 md:mb-0">
                          {isCritical ? (
                            <div className="bg-red-500/20 border border-red-500 text-red-400 px-4 py-2 rounded-lg flex items-center animate-pulse">
                              <AlertOctagon size={18} className="mr-2" />
                              <span className="font-bold">CRITICAL: Underperforming</span>
                            </div>
                          ) : (
                            <div className="bg-green-500/20 border border-green-500 text-green-400 px-4 py-2 rounded-lg flex items-center">
                              <CheckCircle size={18} className="mr-2" />
                              <span className="font-bold">Active & Responsive</span>
                            </div>
                          )}
                       </div>

                       {/* Stats */}
                       <div className="text-right w-full md:w-1/3">
                          <span className="text-3xl font-bold text-white">{Math.round(state.ratio)}%</span>
                          <span className="text-xs text-gray-400 block">Resolution Rate</span>
                       </div>
                     </div>
                   );
                 })}
               </div>
            </div>

            {/* Existing Star City Leaderboard */}
            <div className="bg-gradient-to-br from-gray-800 to-gray-900 p-8 rounded-2xl border border-gray-700 shadow-xl relative overflow-hidden">
               <div className="absolute top-0 right-0 p-8 opacity-10">
                 <Trophy size={200} className="text-yellow-500" />
               </div>
               
               <h3 className="text-2xl font-bold text-white mb-6 flex items-center relative z-10">
                 <Trophy className="mr-3 text-yellow-500" /> National Star City Leaderboard
               </h3>

               <div className="space-y-6 relative z-10">
                 {stats.cityRankings.map((city, index) => (
                   <div key={city.name} className={`p-4 rounded-xl border transition flex items-center ${index === 0 ? 'bg-yellow-900/10 border-yellow-500/50' : 'bg-gray-800/50 border-gray-700'}`}>
                     <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl mr-4 ${
                       index === 0 ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/50' : 
                       index === 1 ? 'bg-gray-400 text-black' : 
                       index === 2 ? 'bg-orange-700 text-white' : 'bg-gray-700 text-gray-400'
                     }`}>
                       {index + 1}
                     </div>
                     
                     <div className="flex-1">
                       <div className="flex justify-between items-end mb-2">
                         <h4 className={`font-bold text-lg ${index === 0 ? 'text-yellow-400' : 'text-gray-200'}`}>
                           {city.name} {index === 0 && <Star className="inline h-4 w-4 fill-yellow-400 ml-1" />}
                         </h4>
                         <div className="text-right">
                           <span className="text-2xl font-bold text-white">{Math.round(city.ratio)}%</span>
                           <span className="text-xs text-gray-400 block">Efficiency</span>
                         </div>
                       </div>
                       
                       {/* Progress Bar */}
                       <div className="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                         <div 
                           className={`h-full rounded-full transition-all duration-1000 ${
                             index === 0 ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : 
                             'bg-blue-600'
                           }`} 
                           style={{ width: `${city.ratio}%` }}
                         ></div>
                       </div>
                     </div>
                   </div>
                 ))}
               </div>
            </div>
            
            <div className="grid md:grid-cols-3 gap-6">
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                   <p className="text-gray-400 mb-2">Total Reports</p>
                   <p className="text-4xl font-bold text-white">{reports.length}</p>
                </div>
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                   <p className="text-gray-400 mb-2">Pending</p>
                   <p className="text-4xl font-bold text-red-500">{reports.filter(r => r.status === 'Pending').length}</p>
                </div>
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                   <p className="text-gray-400 mb-2">Verified Fixed</p>
                   <p className="text-4xl font-bold text-green-500">{reports.filter(r => r.status === 'Resolved').length}</p>
                </div>
            </div>
          </div>
        )}

        {/* FEED VIEW */}
        {activeTab === 'feed' && (
          <div>
            <h2 className="text-3xl font-bold text-white mb-8">Public Dashboard</h2>

            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
              {reports.map((report) => (
                <div key={report.id} className="bg-gray-800 rounded-2xl shadow-lg border border-gray-700 overflow-hidden flex flex-col">
                  {/* Card Header with ID */}
                  <div className="px-6 py-3 bg-gray-750 border-b border-gray-700 flex justify-between items-center">
                     <span className="bg-gray-900 text-gray-400 text-xs font-mono py-1 px-2 rounded border border-gray-700 flex items-center">
                       <Hash size={10} className="mr-1"/> {report.id}
                     </span>
                     <div className="text-right">
                       <span className="text-xs text-white block font-bold">{report.city}</span>
                       <span className="text-xs text-gray-500 block">{report.area}</span>
                     </div>
                  </div>

                  {/* Image Display - Split if Resolved */}
                  <div className="h-48 relative overflow-hidden group bg-gray-900">
                    {report.status === 'Resolved' && report.proofImage ? (
                      <div className="flex h-full w-full">
                        <div className="w-1/2 relative border-r border-white/20">
                          <img src={report.image} className="w-full h-full object-cover" alt="Before" />
                          <div className="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded">BEFORE</div>
                        </div>
                        <div className="w-1/2 relative">
                          <img src={report.proofImage} className="w-full h-full object-cover" alt="After" />
                          <div className="absolute top-2 left-2 bg-green-600 text-white text-[10px] px-2 py-1 rounded font-bold">FIXED</div>
                        </div>
                      </div>
                    ) : (
                      <img 
                        src={report.image} 
                        alt="Report" 
                        className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition duration-500"
                      />
                    )}
                    
                    {report.status !== 'Resolved' && (
                       <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-gray-900 to-transparent p-4">
                          <span className="text-white font-bold text-lg drop-shadow-md">{report.category}</span>
                       </div>
                    )}
                  </div>
                  
                  <div className="p-6 flex-1 flex flex-col">
                    <h3 className="font-semibold text-gray-200 mb-1">{report.location}</h3>
                    <p className="text-gray-400 text-sm mb-4 line-clamp-2">
                      {report.description}
                    </p>
                    
                    {/* Progress Bar Visualization */}
                    <div className="mt-auto">
                      <ProgressBar status={report.status} />
                    </div>
                    
                    <div className="pt-4 mt-4 border-t border-gray-700 flex items-center justify-between">
                      <button 
                        onClick={() => handleUpvote(report.id)}
                        className="flex items-center space-x-2 text-gray-400 hover:text-blue-400 transition"
                      >
                        <ThumbsUp size={18} />
                        <span className="text-sm font-medium">{report.upvotes}</span>
                      </button>
                      <span className="text-xs text-gray-500 flex items-center">
                        <Clock size={12} className="mr-1" /> {report.timestamp}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ADMIN VIEW */}
        {activeTab === 'admin' && (
          <div className="bg-gray-800 rounded-2xl shadow-xl border border-gray-700">
            <div className="p-6 border-b border-gray-700 flex justify-between items-center">
              <div>
                <h2 className="text-xl font-bold text-white">Official Portal</h2>
                <p className="text-sm text-gray-400">Department of Works</p>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="bg-gray-900 border-b border-gray-700 text-xs uppercase text-gray-400 font-semibold">
                    <th className="p-4">ID</th>
                    <th className="p-4">City/Area</th>
                    <th className="p-4">Type</th>
                    <th className="p-4">Pressure</th>
                    <th className="p-4">Status</th>
                    <th className="p-4">Action</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-700">
                  {reports.map((report) => (
                    <tr key={report.id} className="hover:bg-gray-750 transition">
                      <td className="p-4 font-mono text-blue-400 text-sm">{report.id}</td>
                      <td className="p-4">
                        <div className="text-gray-300 font-bold text-sm">{report.city}</div>
                        <div className="text-gray-500 text-xs">{report.area}</div>
                      </td>
                      <td className="p-4 text-gray-300">{report.category}</td>
                      <td className="p-4">
                        <div className="flex items-center text-orange-500 font-bold">
                          <Activity size={14} className="mr-1" />
                          {report.upvotes}
                        </div>
                      </td>
                      <td className="p-4">
                         <span className={`px-2 py-1 rounded-full text-xs border ${
                          report.status === 'Resolved' ? 'bg-green-900/30 text-green-400 border-green-800' :
                          report.status === 'In Progress' ? 'bg-yellow-900/30 text-yellow-400 border-yellow-800' :
                          'bg-red-900/30 text-red-400 border-red-800'
                        }`}>
                          {report.status}
                        </span>
                      </td>
                      <td className="p-4">
                        <div className="flex space-x-2">
                          {report.status === 'Resolved' ? (
                             <span className="flex items-center text-green-500 text-xs font-bold">
                               <CheckCircle size={14} className="mr-1" /> Verified
                             </span>
                          ) : (
                            <>
                              <button 
                                onClick={() => updateStatus(report.id, 'In Progress')}
                                className="text-gray-400 hover:text-white border border-gray-600 px-3 py-1 rounded text-xs transition"
                                disabled={report.status === 'In Progress'}
                              >
                                Accept
                              </button>
                              <button 
                                onClick={() => setResolvingId(report.id)}
                                className="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-500 flex items-center shadow-lg shadow-green-900/20"
                              >
                                <Upload size={12} className="mr-1" /> Verify & Close
                              </button>
                            </>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

      </main>
    </div>
  );
};

export default SmartRoadMonitoring;
