<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Road Monitoring</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map (UPDATED to stable Firebase v10.13.2) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar for Webkit */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Error Overlay Styles */
        #error-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            color: #ef4444;
            z-index: 9999;
            padding: 2rem;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased">
    <div id="root"></div>
    
    <!-- Error Overlay for Debugging -->
    <div id="error-overlay">
        <h1 class="text-2xl font-bold mb-4">Application Error</h1>
        <p>If you see this, something went wrong with the code.</p>
        <div id="error-message" class="mt-4 p-4 border border-red-500 rounded bg-red-900/20"></div>
    </div>

    <!-- Error Handler Script -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const overlay = document.getElementById('error-overlay');
            const msgDiv = document.getElementById('error-message');
            overlay.style.display = 'block';
            msgDiv.textContent = `Error: ${msg}\nLine: ${line}\nColumn: ${col}`;
            return false;
        };
        
        // Catch unhandled promise rejections (like Firebase init errors)
        window.onunhandledrejection = function(event) {
            const overlay = document.getElementById('error-overlay');
            const msgDiv = document.getElementById('error-message');
            overlay.style.display = 'block';
            msgDiv.textContent = `Promise Error: ${event.reason}`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, MapPin, Send, AlertTriangle, CheckCircle, Clock, ThumbsUp, 
            MessageSquare, X, Upload, BarChart2, Activity, Hash, ChevronRight, 
            Eye, Check, Trophy, Star, TrendingUp, AlertOctagon, Landmark, 
            Navigation, Globe, Map, Sparkles, FileText, List, ChevronDown, Calendar
        } from 'lucide-react';

        // Firebase Imports
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithCustomToken, 
            signInAnonymously, 
            onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            onSnapshot, 
            serverTimestamp
        } from 'firebase/firestore';

        // --- Firebase Initialization ---
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; 

        // YOUR KEYS
        const firebaseConfig = {
            apiKey: "AIzaSyAqIsVhv0N_V_z3ENsYZz76sRQfYlwIrkM",
            authDomain: "civicfix-fbfcc.firebaseapp.com",
            projectId: "civicfix-fbfcc",
            storageBucket: "civicfix-fbfcc.firebasestorage.app",
            messagingSenderId: "291507757806",
            appId: "1:291507757806:web:0bfcffd778b8e1488c09ff"
        };

        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch(e) {
            console.error("Firebase Init Error:", e);
            throw new Error("Firebase configuration failed. Check your keys.");
        }

        // --- Static Data ---
        // Complete list of Indian States and Districts
        const locationData = {
            "Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Sri Potti Sriramulu Nellore", "Visakhapatnam", "Vizianagaram", "West Godavari", "YSR Kadapa", "Parvathipuram Manyam", "Anakapalli", "Alluri Sitharama Raju", "Kakinada", "Konaseema", "Eluru", "NTR", "Bapatla", "Palnadu", "Nandyal", "Sri Sathya Sai", "Annamayya", "Tirupati"],
            "Arunachal Pradesh": ["Anjaw", "Changlang", "Dibang Valley", "East Kameng", "East Siang", "Kamle", "Kra Daadi", "Kurung Kumey", "Lepa Rada", "Lohit", "Longding", "Lower Dibang Valley", "Lower Siang", "Lower Subansiri", "Namsai", "Pakke Kessang", "Papum Pare", "Shi Yomi", "Siang", "Tawang", "Tirap", "Upper Siang", "Upper Subansiri", "West Kameng", "West Siang", "Itanagar Capital Complex"],
            "Assam": ["Baksa", "Barpeta", "Biswanath", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Hojai", "Jorhat", "Kamrup", "Kamrup Metropolitan", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Majuli", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "South Salmara-Mankachar", "Tinsukia", "Udalguri", "West Karbi Anglong", "Bajali", "Tamulpur"],
            "Bihar": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"],
            "Chhattisgarh": ["Balod", "Baloda Bazar", "Balrampur", "Bastar", "Bemetara", "Bijapur", "Bilaspur", "Dantewada", "Dhamtari", "Durg", "Gariaband", "Gaurela-Pendra-Marwahi", "Janjgir-Champa", "Jashpur", "Kabirdham", "Kanker", "Kondagaon", "Korba", "Koriya", "Mahasamund", "Mungeli", "Narayanpur", "Raigarh", "Raipur", "Rajnandgaon", "Sukma", "Surajpur", "Surguja", "Khairagarh-Chhuikhadan-Gandai", "Manendragarh-Chirmiri-Bharatpur", "Mohla-Manpur-Ambagarh Chowki", "Sarangarh-Bilaigarh", "Shakti"],
            "Goa": ["North Goa", "South Goa"],
            "Gujarat": ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad", "Chhota Udaipur", "Dahod", "Dang", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kheda", "Kutch", "Mahisagar", "Mehsana", "Morbi", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar", "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Vadodara", "Valsad"],
            "Haryana": ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Nuh", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"],
            "Himachal Pradesh": ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"],
            "Jharkhand": ["Bokaro", "Chatra", "Deoghar", "Dhanbad", "Dumka", "East Singhbhum", "Garhwa", "Giridih", "Godda", "Gumla", "Hazaribagh", "Jamtara", "Khunti", "Koderma", "Latehar", "Lohardaga", "Pakur", "Palamu", "Ramgarh", "Ranchi", "Sahibganj", "Seraikela-Kharsawan", "Simdega", "West Singhbhum"],
            "Karnataka": ["Bagalkot", "Bangalore Rural", "Bangalore Urban", "Belgaum", "Bellary", "Bidar", "Bijapur", "Chamarajanagar", "Chikkaballapur", "Chikmagalur", "Chitradurga", "Dakshina Kannada", "Davangere", "Dharwad", "Gadag", "Gulbarga", "Hassan", "Haveri", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysore", "Raichur", "Ramanagara", "Shimoga", "Tumkur", "Udupi", "Uttara Kannada", "Yadgir", "Vijayanagara"],
            "Kerala": ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappuram", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"],
            "Madhya Pradesh": ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad (Narmadapuram)", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Niwari", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha", "Mauganj", "Pandhurna", "Maihar"],
            "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad (Chhatrapati Sambhajinagar)", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad (Dharashiv)", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"],
            "Manipur": ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"],
            "Meghalaya": ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills", "Eastern West Khasi Hills"],
            "Mizoram": ["Aizawl", "Champhai", "Hnahthial", "Khawzawl", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Saitual", "Serchhip"],
            "Nagaland": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto", "Noklak", "Chümoukedima", "Niuland", "Tseminyu", "Shamator"],
            "Odisha": ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghpur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar", "Khurda", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Subarnapur", "Sundargarh"],
            "Punjab": ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Muktsar", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar (Mohali)", "Sangrur", "Shahid Bhagat Singh Nagar (Nawanshahr)", "Sri Muktsar Sahib", "Tarn Taran", "Malerkotla"],
            "Rajasthan": ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Bharatpur", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur", "Anupgarh", "Balotra", "Beawar", "Deeg", "Didwana-Kuchaman", "Dudu", "Gangapur City", "Jaipur Rural", "Jodhpur Rural", "Kekri", "Khairthal-Tijara", "Kotputli-Behror", "Neem Ka Thana", "Phalodi", "Salumbar", "Sanchore", "Shahpura"],
            "Sikkim": ["Gangtok", "Gyalshing", "Pakyong", "Soreng", "Mangan", "Namchi"],
            "Tamil Nadu": ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"],
            "Telangana": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal", "Nagarkurnool", "Nalgonda", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Rangareddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal", "Hanamkonda", "Yadadri Bhuvanagiri", "Mulugu", "Narayanpet"],
            "Tripura": ["Dhalai", "Gomati", "Khowai", "North Tripura", "Sepahijala", "South Tripura", "Unakoti", "West Tripura"],
            "Uttar Pradesh": ["Agra", "Aligarh", "Ambedkar Nagar", "Amethi", "Amroha", "Auraiya", "Ayodhya", "Azamgarh", "Baghpat", "Bahraich", "Ballia", "Balrampur", "Banda", "Barabanki", "Bareilly", "Basti", "Bhadohi", "Bijnor", "Budaun", "Bulandshahr", "Chandauli", "Chitrakoot", "Deoria", "Etah", "Etawah", "Farrukhabad", "Fatehpur", "Firozabad", "Gautam Buddha Nagar", "Ghaziabad", "Ghazipur", "Gonda", "Gorakhpur", "Hamirpur", "Hapur", "Hardoi", "Hathras", "Jalaun", "Jaunpur", "Jhansi", "Kannauj", "Kanpur Dehat", "Kanpur Nagar", "Kasganj", "Kaushambi", "Lakhimpur Kheri", "Kushinagar", "Lalitpur", "Lucknow", "Maharajganj", "Mahoba", "Mainpuri", "Mathura", "Mau", "Meerut", "Mirzapur", "Moradabad", "Muzaffarnagar", "Pilibhit", "Pratapgarh", "Prayagraj", "Raebareli", "Rampur", "Saharanpur", "Sambhal", "Sant Kabir Nagar", "Shahjahanpur", "Shamli", "Shravasti", "Siddharthnagar", "Sitapur", "Sonbhadra", "Sultanpur", "Unnao", "Varanasi"],
            "Uttarakhand": ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragarh", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"],
            "West Bengal": ["Alipurduar", "Bankura", "Birbhum", "Cooch Behar", "Dakshin Dinajpur", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Jhargram", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Bardhaman", "Paschim Medinipur", "Purba Bardhaman", "Purba Medinipur", "Purulia", "South 24 Parganas", "Uttar Dinajpur"],
            "Andaman and Nicobar Islands": ["Nicobar", "North and Middle Andaman", "South Andaman"],
            "Chandigarh": ["Chandigarh"],
            "Dadra and Nagar Haveli and Daman and Diu": ["Dadra and Nagar Haveli", "Daman", "Diu"],
            "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"],
            "Jammu and Kashmir": ["Anantnag", "Bandipora", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"],
            "Ladakh": ["Kargil", "Leh"],
            "Lakshadweep": ["Lakshadweep"],
            "Puducherry": ["Karaikal", "Mahe", "Puducherry", "Yanam"]
        };

        const stateGovtMap = {
            "Karnataka": { party: "People's Progressive Party", color: "text-green-400" },
            "Maharashtra": { party: "United Alliance Front", color: "text-orange-400" },
            "Delhi": { party: "Capital Care Party", color: "text-blue-400" },
            "Tamil Nadu": { party: "Southern League", color: "text-yellow-400" },
            "Uttar Pradesh": { party: "Janata Vikas", color: "text-red-400" },
            "Kerala": { party: "Left Democratic Front", color: "text-red-500" },
            "West Bengal": { party: "Trinamool Congress", color: "text-green-500" },
            "Gujarat": { party: "Bharatiya Janata Party", color: "text-orange-500" },
            "Rajasthan": { party: "Indian National Congress", color: "text-blue-500" },
            "Telangana": { party: "Bharat Rashtra Samithi", color: "text-pink-400" },
            "Bihar": { party: "Janata Dal (United)", color: "text-green-300" },
            "Punjab": { party: "Aam Aadmi Party", color: "text-blue-300" }
        };

        // --- Components ---

        const ProgressBar = React.memo(({ status }) => {
            const steps = ['Reported', 'In Progress', 'Resolved'];
            const currentStep = status === 'Pending' ? 0 : status === 'In Progress' ? 1 : 2;

            return (
              <div className="w-full mt-4">
                <div className="flex justify-between mb-2">
                  {steps.map((step, index) => (
                    <div key={step} className={`text-xs font-semibold ${index <= currentStep ? 'text-blue-400' : 'text-gray-600'}`}>
                      {step}
                    </div>
                  ))}
                </div>
                <div className="h-2 bg-gray-700 rounded-full overflow-hidden flex">
                  {steps.map((step, index) => (
                    <div 
                      key={index} 
                      className={`h-full flex-1 border-r border-gray-800 last:border-0 transition-all duration-500 ${
                        index <= currentStep ? (index === 2 ? 'bg-green-500' : 'bg-blue-500') : 'bg-gray-700'
                      }`} 
                    />
                  ))}
                </div>
              </div>
            );
        });

        const FeedCard = React.memo(({ report, onUpvote }) => {
          return (
            <div className="bg-gray-800 rounded-2xl shadow-lg border border-gray-700 overflow-hidden flex flex-col fade-in">
              <div className="px-6 py-3 bg-gray-750 border-b border-gray-700 flex justify-between items-center">
                 <span className="bg-gray-900 text-gray-400 text-xs font-mono py-1 px-2 rounded border border-gray-700 flex items-center">
                   <Hash size={10} className="mr-1"/> {report.id}
                 </span>
                 <div className="text-right">
                   <span className="text-xs text-white block font-bold">{report.district}</span>
                   <span className="text-xs text-gray-500 block">{report.state}</span>
                 </div>
              </div>

              <div className="h-48 relative overflow-hidden group bg-gray-900">
                {report.status === 'Resolved' && report.proofImage ? (
                  <div className="flex h-full w-full">
                    <div className="w-1/2 relative border-r border-white/20">
                      <img src={report.image} className="w-full h-full object-cover" alt="Before" loading="lazy" />
                      <div className="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded">BEFORE</div>
                    </div>
                    <div className="w-1/2 relative">
                      <img src={report.proofImage} className="w-full h-full object-cover" alt="After" loading="lazy" />
                      <div className="absolute top-2 left-2 bg-green-600 text-white text-[10px] px-2 py-1 rounded font-bold">FIXED</div>
                    </div>
                  </div>
                ) : (
                  <img 
                    src={report.image} 
                    alt="Report" 
                    className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition duration-500"
                    loading="lazy"
                  />
                )}
                
                {report.status !== 'Resolved' && (
                   <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-gray-900 to-transparent p-4">
                      <span className="text-white font-bold text-lg drop-shadow-md">{report.category}</span>
                   </div>
                )}
              </div>
              
              <div className="p-6 flex-1 flex flex-col">
                <h3 className="font-semibold text-gray-200 mb-1 flex items-center justify-between">
                  <span className="truncate pr-2">{report.area}</span>
                  {report.coordinates && (
                    <a 
                      href={`https://www.google.com/maps/search/?api=1&query=${report.coordinates.lat},${report.coordinates.lng}`} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="text-blue-500 hover:text-blue-400 bg-blue-900/30 p-1.5 rounded-lg transition"
                      title="View Exact Location on Maps"
                    >
                      <MapPin size={16} />
                    </a>
                  )}
                </h3>
                <p className="text-gray-400 text-sm mb-4 line-clamp-2">
                  {report.description}
                </p>
                
                <div className="mt-auto">
                  <ProgressBar status={report.status} />
                </div>
                
                <div className="pt-4 mt-4 border-t border-gray-700 flex items-center justify-between">
                  <button 
                    onClick={() => onUpvote(report.firestoreId || report.id, report.upvotes)}
                    className="flex items-center space-x-2 text-gray-400 hover:text-blue-400 transition"
                  >
                    <ThumbsUp size={18} />
                    <span className="text-sm font-medium">{report.upvotes}</span>
                  </button>
                  <span className="text-xs text-gray-500 flex items-center">
                    <Clock size={12} className="mr-1" /> {report.timestamp}
                  </span>
                </div>
              </div>
            </div>
          );
        });

        // Helper: Format Date
        const formatDate = (timestamp) => {
            if (!timestamp) return 'Just now';
            // Handle Firestore Timestamp
            if (timestamp.seconds) {
                return new Date(timestamp.seconds * 1000).toLocaleDateString('en-IN', {
                    day: 'numeric', month: 'short', year: 'numeric'
                });
            }
            // Handle string
            return timestamp;
        };

        const AdminRow = React.memo(({ report, onStatusUpdate, onVerifyStart, formatDate }) => {
          return (
            <tr className="hover:bg-gray-750 transition">
              <td className="p-4 font-mono text-blue-400 text-sm">{report.id}</td>
              <td className="p-4">
                <div className="text-gray-300 font-bold text-sm">{report.district}</div>
                <div className="text-gray-500 text-xs mt-1 flex items-center">
                    <Clock size={10} className="mr-1"/>
                    {formatDate(report.createdAt || report.timestamp)}
                </div>
              </td>
              <td className="p-4 text-gray-300">{report.category}</td>
              <td className="p-4">
                <div className="flex items-center text-orange-500 font-bold">
                  <Activity size={14} className="mr-1" />
                  {report.upvotes}
                </div>
              </td>
              <td className="p-4">
                 <span className={`px-2 py-1 rounded-full text-xs border ${
                  report.status === 'Resolved' ? 'bg-green-900/30 text-green-400 border-green-800' :
                  report.status === 'In Progress' ? 'bg-yellow-900/30 text-yellow-400 border-yellow-800' :
                  'bg-red-900/30 text-red-400 border-red-800'
                }`}>
                  {report.status}
                </span>
              </td>
              <td className="p-4">
                <div className="flex space-x-2">
                  {report.status === 'Resolved' ? (
                     <span className="flex items-center text-green-500 text-xs font-bold">
                       <CheckCircle size={14} className="mr-1" /> Verified
                     </span>
                  ) : (
                    <>
                      <button 
                        onClick={() => onStatusUpdate(report.firestoreId || report.id, 'In Progress')}
                        className="text-gray-400 hover:text-white border border-gray-600 px-3 py-1 rounded text-xs transition"
                        disabled={report.status === 'In Progress'}
                      >
                        Accept
                      </button>
                      <button 
                        onClick={() => onVerifyStart(report.firestoreId || report.id)}
                        className="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-500 flex items-center shadow-lg shadow-green-900/20"
                      >
                        <Upload size={12} className="mr-1" /> Verify & Close
                      </button>
                    </>
                  )}
                </div>
              </td>
            </tr>
          );
        });

        const TrendChart = ({ data }) => {
            // Mock data structure: { label: '2021', value: 45 }, etc.
            const years = ['2020', '2021', '2022', '2023', '2024'];
            // Mock improvement data for top 3 districts
            const districts = [
                { name: 'Bangalore Urban', data: [30, 45, 55, 68, 82], color: '#3b82f6' }, // Blue
                { name: 'Mumbai Suburban', data: [25, 35, 48, 60, 75], color: '#10b981' }, // Green
                { name: 'New Delhi', data: [40, 50, 58, 65, 78], color: '#f59e0b' } // Amber
            ];

            const height = 200;
            const width = 500;
            const padding = 40;
            const yMax = 100;

            const getX = (index) => padding + index * ((width - 2 * padding) / (years.length - 1));
            const getY = (val) => height - padding - (val / yMax) * (height - 2 * padding);

            return (
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 mt-6 overflow-hidden">
                    <h3 className="text-gray-300 mb-6 font-bold flex items-center">
                        <TrendingUp className="mr-2 text-blue-400" size={20}/> 
                        Road Quality Index (5-Year Trend)
                    </h3>
                    <div className="overflow-x-auto">
                        <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} className="min-w-[500px]">
                            {/* Grid Lines */}
                            {[0, 25, 50, 75, 100].map(val => (
                                <line 
                                    key={val} 
                                    x1={padding} 
                                    y1={getY(val)} 
                                    x2={width - padding} 
                                    y2={getY(val)} 
                                    stroke="#374151" 
                                    strokeWidth="1" 
                                />
                            ))}

                            {/* Axis Labels */}
                            {years.map((year, i) => (
                                <text key={year} x={getX(i)} y={height - 10} textAnchor="middle" fill="#9ca3af" fontSize="12">{year}</text>
                            ))}
                            <text x={10} y={getY(100)} fill="#9ca3af" fontSize="10">100%</text>
                            <text x={10} y={getY(0)} fill="#9ca3af" fontSize="10">0%</text>

                            {/* Lines */}
                            {districts.map((d, i) => {
                                const pathD = d.data.map((val, index) => 
                                    `${index === 0 ? 'M' : 'L'} ${getX(index)} ${getY(val)}`
                                ).join(' ');
                                
                                return (
                                    <g key={d.name}>
                                        <path d={pathD} fill="none" stroke={d.color} strokeWidth="3" />
                                        {d.data.map((val, index) => (
                                            <circle 
                                                key={index} 
                                                cx={getX(index)} 
                                                cy={getY(val)} 
                                                r="4" 
                                                fill={d.color} 
                                                className="hover:r-6 transition-all cursor-pointer"
                                            >
                                                <title>{d.name}: {val}%</title>
                                            </circle>
                                        ))}
                                    </g>
                                );
                            })}
                        </svg>
                    </div>
                    <div className="flex justify-center mt-4 space-x-6">
                        {districts.map(d => (
                            <div key={d.name} className="flex items-center text-xs text-gray-400">
                                <span className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: d.color}}></span>
                                {d.name}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Helper: Compress Image
        const compressImage = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL(file.type, 0.7)); 
              };
              img.onerror = (error) => reject(error);
            };
            reader.onerror = (error) => reject(error);
          });
        };

        const SmartRoadMonitoring = () => {
          const [activeTab, setActiveTab] = useState('home'); 
          // Note: API Key is defined globally above

          const [user, setUser] = useState(null);
          const [reports, setReports] = useState([]);
          const [loadingData, setLoadingData] = useState(true);
          const [visibleCount, setVisibleCount] = useState(9);
          const [adminVisibleCount, setAdminVisibleCount] = useState(20);
          const [adminSortBy, setAdminSortBy] = useState('upvotes'); // Default to upvotes

          // Auth & Data
          useEffect(() => {
            const initAuth = async () => {
              try {
                if (auth) {
                  await signInAnonymously(auth);
                }
              } catch (error) {
                console.error("Auth failed", error);
              }
            };
            initAuth();
            
            if (auth) {
              const unsubscribe = onAuthStateChanged(auth, setUser);
              return () => unsubscribe();
            }
          }, []);

          useEffect(() => {
            if (!user || !db) return;

            try {
                const reportsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
                
                const unsubscribe = onSnapshot(reportsCollection, (snapshot) => {
                  const fetchedReports = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    firestoreId: doc.id
                  }));
                  
                  fetchedReports.sort((a, b) => {
                    const tA = a.createdAt?.seconds || 0;
                    const tB = b.createdAt?.seconds || 0;
                    return tB - tA;
                  });

                  setReports(fetchedReports);
                  setLoadingData(false);
                }, (error) => {
                  console.error("Error fetching reports:", error);
                  setLoadingData(false);
                });

                return () => unsubscribe();
            } catch (err) {
                console.error("Firestore Error:", err);
            }
          }, [user]);

          useEffect(() => {
            setVisibleCount(9);
            setAdminVisibleCount(20);
          }, [activeTab]);

          const [resolvingId, setResolvingId] = useState(null);
          const [proofImage, setProofImage] = useState(null); 
          const [isManualState, setIsManualState] = useState(false);
          const [isManualDistrict, setIsManualDistrict] = useState(false);

          const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
          const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
          const [imageBase64, setImageBase64] = useState(null);
          const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);
          const [aiSummary, setAiSummary] = useState(null);

          const stats = useMemo(() => {
            const areaCounts = {};
            const categoryCounts = {};
            const districtStats = {};
            const stateStats = {};

            reports.forEach(r => {
              areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
              categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;

              const districtKey = `${r.district}, ${r.state}`;
              if (!districtStats[districtKey]) {
                districtStats[districtKey] = { name: r.district, state: r.state, total: 0, resolved: 0 };
              }
              districtStats[districtKey].total += 1;
              
              if (!stateStats[r.state]) {
                stateStats[r.state] = { name: r.state, total: 0, resolved: 0 };
              }
              stateStats[r.state].total += 1;

              if (r.status === 'Resolved') {
                districtStats[districtKey].resolved += 1;
                stateStats[r.state].resolved += 1;
              }
            });

            const sortedAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]);
            const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);

            const districtRankings = Object.values(districtStats).map(d => ({
              ...d,
              ratio: d.total > 0 ? (d.resolved / d.total) * 100 : 0
            })).sort((a, b) => b.ratio - a.ratio); 

            const stateRankings = Object.values(stateStats).map(state => ({
              ...state,
              ratio: state.total > 0 ? (state.resolved / state.total) * 100 : 0,
              govt: stateGovtMap[state.name] || { party: "Independent", color: "text-gray-400" }
            })).sort((a, b) => b.ratio - a.ratio);

            return { sortedAreas, sortedCategories, districtRankings, stateRankings };
          }, [reports]);

          const [newReport, setNewReport] = useState({
            state: 'Karnataka',
            district: 'Bangalore Urban',
            area: '',
            location: '',
            coordinates: null, 
            category: '',
            description: '',
            image: null
          });

          const handleFileChange = async (e, setFunction, currentObj) => {
            const file = e.target.files[0];
            if (file) {
              try {
                const compressedBase64 = await compressImage(file);
                const rawBase64 = compressedBase64.split(',')[1];
                setImageBase64(rawBase64);
                
                if (currentObj) {
                   setFunction({ ...currentObj, image: compressedBase64 });
                } else {
                   setFunction(compressedBase64);
                }
              } catch (err) {
                console.error("Compression error:", err);
                alert("Error processing image. Please try another.");
              }
            }
          };

          const analyzeImageWithGemini = async () => {
            if (!imageBase64) {
              alert("Please upload an image first.");
              return;
            }
            
            setIsAnalyzingImage(true);
            setAiAnalysisResult(null);

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{
                    role: "user",
                    parts: [
                      { text: "Identify the road infrastructure issue in this image. Categorize it as one of: Pothole, Street Light, Road Crack, Broken Signal, Faded Markings, Damaged Manhole, Missing Signage. Provide a short, professional description for a civic complaint. Return valid JSON only with keys: 'category' and 'description'." },
                      { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }
                    ]
                  }],
                  generationConfig: {
                    responseMimeType: "application/json"
                  }
                })
              });

              const data = await response.json();
              const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
              
              if (resultText) {
                const result = JSON.parse(resultText);
                setNewReport(prev => ({
                  ...prev,
                  category: result.category || prev.category,
                  description: result.description || prev.description
                }));
                setAiAnalysisResult("Auto-filled by AI ✨");
              }
            } catch (error) {
              console.error("Gemini Analysis Error:", error);
              alert("AI analysis failed. Please enter details manually.");
            } finally {
              setIsAnalyzingImage(false);
            }
          };

          const generateInsightsWithGemini = async () => {
            setIsGeneratingSummary(true);
            setAiSummary(null);

            const dataContext = `
              Top Issues: ${JSON.stringify(stats.sortedCategories.slice(0, 3))}
              State Performance: ${JSON.stringify(stats.stateRankings.map(s => ({name: s.name, ratio: s.ratio})))}
            `;

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{
                    parts: [{ text: `Act as a civic data analyst. Analyze this road issue data: ${dataContext}. Write a 3-bullet point executive summary for the City Commissioner. Use emojis.` }]
                  }]
                })
              });

              const data = await response.json();
              const summary = data.candidates?.[0]?.content?.parts?.[0]?.text;
              setAiSummary(summary);
            } catch (error) {
              console.error("Gemini Summary Error:", error);
              alert("Could not generate summary.");
            } finally {
              setIsGeneratingSummary(false);
            }
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!user) { alert("Please wait for initialization."); return; }

            const report = {
              id: `WRD-${Math.floor(Math.random() * 90) + 10}-${Math.floor(Math.random() * 9000) + 1000}`,
              state: newReport.state || "Unknown",
              district: newReport.district || "Unknown",
              area: newReport.area,
              location: newReport.location,
              coordinates: newReport.coordinates,
              category: newReport.category,
              description: newReport.description,
              status: "Pending",
              upvotes: 0,
              createdAt: serverTimestamp(),
              timestamp: "Just now",
              image: newReport.image || "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
              proofImage: null,
              comments: []
            };

            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), report);
              setNewReport({ state: 'Karnataka', district: 'Bangalore Urban', area: '', location: '', coordinates: null, category: 'Pothole', description: '', image: null });
              setActiveTab('feed');
            } catch (err) {
              console.error("Error saving report:", err);
            }
          };

          const updateStatus = useCallback(async (docId, newStatus) => {
            if (!docId || !user) return;
            try {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', docId);
              await updateDoc(docRef, { status: newStatus });
            } catch (err) { console.error("Update failed", err); }
          }, [user]);

          const submitResolution = async () => {
            if (!proofImage) { alert("Please upload a photo of the fixed road."); return; }
            if (!resolvingId || !user) return;
            try {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', resolvingId);
              await updateDoc(docRef, { status: 'Resolved', proofImage: proofImage });
              setResolvingId(null);
              setProofImage(null);
            } catch (err) { console.error("Resolution submit failed", err); }
          };

          const handleUpvote = useCallback(async (docId, currentUpvotes) => {
            if (!docId || !user) return;
            try {
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', docId);
              await updateDoc(docRef, { upvotes: currentUpvotes + 1 });
            } catch (err) { console.error("Upvote failed", err); }
          }, [user]);

          return (
            <div className="min-h-screen bg-gray-900 font-sans text-gray-100 pb-20">
              
              {/* Modal */}
              {resolvingId && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                  <div className="bg-gray-800 rounded-2xl w-full max-w-md p-6 border border-gray-700 shadow-2xl">
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-bold text-white">Close Ticket</h3>
                      <button onClick={() => {setResolvingId(null); setProofImage(null);}} className="text-gray-400 hover:text-white">
                        <X />
                      </button>
                    </div>
                    <div className="space-y-4">
                      <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center bg-gray-700/50 relative">
                        <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, setProofImage, null)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        {proofImage ? ( <img src={proofImage} alt="Proof" className="h-40 w-full object-cover rounded-lg mx-auto" /> ) : ( <div className="flex flex-col items-center"><Upload className="text-blue-400 mb-2" size={32} /><p className="text-blue-300 font-medium">Upload Proof</p></div> )}
                      </div>
                      <button onClick={submitResolution} className={`w-full py-3 rounded-xl font-bold transition ${proofImage ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-gray-700 text-gray-500'}`} disabled={!proofImage}>Verify & Close</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Navbar */}
              <nav className="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between h-16 items-center">
                    <div className="flex items-center cursor-pointer" onClick={() => setActiveTab('home')}>
                      <div className="bg-blue-600 p-2 rounded-lg mr-2"><MapPin className="text-white" size={24} /></div>
                      <span className="font-bold text-xl tracking-tight text-white">Smart Road</span>
                    </div>
                    <div className="hidden md:flex space-x-8">
                      {['home', 'feed', 'stats', 'admin'].map((tab) => (
                        <button key={tab} onClick={() => setActiveTab(tab)} className={`capitalize ${activeTab === tab ? 'text-blue-400 font-bold' : 'text-gray-400 hover:text-white'}`}>{tab === 'feed' ? 'Dashboard' : tab === 'stats' ? 'Analytics' : tab === 'admin' ? 'Official' : tab}</button>
                      ))}
                    </div>
                    <button onClick={() => setActiveTab('report')} className="bg-blue-600 text-white px-5 py-2 rounded-full font-medium shadow-lg hover:bg-blue-500 transition flex items-center"><Camera size={18} className="mr-2" /> Report</button>
                  </div>
                </div>
              </nav>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {activeTab === 'home' && (
                  <div className="space-y-12">
                    {/* Hero Section */}
                    <section className="relative text-center py-16 px-4 overflow-hidden">
                      <div className="relative z-10 max-w-4xl mx-auto">
                        <div className="inline-block mb-6 px-4 py-1.5 rounded-full bg-blue-900/30 border border-blue-500/30 text-blue-300 text-sm font-medium animate-pulse">
                          Citizen-Led Infrastructure Improvement
                        </div>
                        <h1 className="text-5xl md:text-6xl font-extrabold text-white mb-6 tracking-tight leading-tight">
                          Smart Road Monitoring <br/>
                          <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">Smoother Journeys.</span>
                        </h1>
                        
                        <p className="text-xl text-gray-400 mb-10 max-w-2xl mx-auto leading-relaxed">
                          Join thousands of citizens making roads safer. Report potholes, broken lights, and hazards in seconds.
                        </p>

                        {/* Quote Section - Prominently Displayed */}
                        <div className="bg-gray-800/50 backdrop-blur-md border border-gray-700 p-8 rounded-2xl max-w-3xl mx-auto mb-10 shadow-2xl transform hover:scale-[1.01] transition duration-300">
                           <p className="text-3xl font-serif italic text-white mb-2">"Your shutter can save a life."</p>
                           <p className="text-sm text-gray-400 uppercase tracking-widest font-semibold">One Photo = One Accident Less</p>
                        </div>

                        {/* Action Buttons - Moved to Top */}
                        <div className="flex flex-col sm:flex-row justify-center gap-4">
                          <button 
                            onClick={() => setActiveTab('report')} 
                            className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-600/30 hover:bg-blue-500 hover:shadow-blue-600/50 transition transform hover:-translate-y-1 flex items-center justify-center"
                          >
                            <Camera className="mr-2" /> File Complaint
                          </button>
                          <button 
                            onClick={() => setActiveTab('stats')} 
                            className="bg-gray-800 text-white border border-gray-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-700 hover:border-gray-600 transition flex items-center justify-center"
                          >
                            <BarChart2 className="mr-2" /> View Analytics
                          </button>
                        </div>
                      </div>
                    </section>

                    {/* Stats Section - Moved Below */}
                    <div className="max-w-7xl mx-auto px-4 pb-12">
                        <div className="flex items-center mb-8">
                            <div className="h-px bg-gray-700 flex-1"></div>
                            <span className="px-4 text-gray-500 font-medium uppercase text-sm tracking-widest">National Performance Insights</span>
                            <div className="h-px bg-gray-700 flex-1"></div>
                        </div>
                        
                        <div className="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto">
                            {/* Star City */}
                            <div className="bg-gray-800/80 backdrop-blur border border-gray-700 p-8 rounded-2xl relative overflow-hidden group hover:border-yellow-500/50 transition duration-300 shadow-xl">
                                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition"><Trophy size={120} className="text-yellow-500" /></div>
                                <div className="relative z-10">
                                    <div className="flex items-center space-x-3 mb-4">
                                        <div className="p-2 bg-yellow-900/30 rounded-lg text-yellow-500"><Star size={24} fill="currentColor" /></div>
                                        <h3 className="text-gray-300 font-bold uppercase tracking-wide text-sm">Top Performing District</h3>
                                    </div>
                                    <p className="text-4xl font-extrabold text-white mb-1">{stats.districtRankings.length > 0 ? stats.districtRankings[0].name : "N/A"}</p>
                                    <div className="flex items-center space-x-2 text-green-400 font-bold text-lg">
                                        <TrendingUp size={20} />
                                        <span>{Math.round(stats.districtRankings.length > 0 ? stats.districtRankings[0].ratio : 0)}% Resolution Rate</span>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-4">Setting the benchmark for civic responsiveness and road safety standards.</p>
                                </div>
                            </div>

                            {/* Worst City */}
                            <div className="bg-gray-800/80 backdrop-blur border border-gray-700 p-8 rounded-2xl relative overflow-hidden group hover:border-red-500/50 transition duration-300 shadow-xl">
                                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition"><AlertOctagon size={120} className="text-red-500" /></div>
                                <div className="relative z-10">
                                    <div className="flex items-center space-x-3 mb-4">
                                        <div className="p-2 bg-red-900/30 rounded-lg text-red-500"><AlertTriangle size={24} /></div>
                                        <h3 className="text-gray-300 font-bold uppercase tracking-wide text-sm">Critical Attention Required</h3>
                                    </div>
                                    <p className="text-4xl font-extrabold text-white mb-1">{stats.districtRankings.length > 0 ? stats.districtRankings[stats.districtRankings.length - 1].name : "N/A"}</p>
                                    <div className="flex items-center space-x-2 text-red-400 font-bold text-lg">
                                        <Activity size={20} />
                                        <span>{Math.round(stats.districtRankings.length > 0 ? stats.districtRankings[stats.districtRankings.length - 1].ratio : 0)}% Resolution Rate</span>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-4">Immediate administrative intervention required to improve road infrastructure.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>
                )}

                {activeTab === 'report' && (
                  <div className="max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-hidden">
                    <div className="bg-blue-600 p-6 text-white"><h2 className="text-2xl font-bold flex items-center"><AlertTriangle className="mr-3" /> New Report</h2></div>
                    <form onSubmit={handleSubmit} className="p-8 space-y-6">
                        <div className="space-y-4">
                             <div className="flex justify-between items-center"><label className="text-sm font-medium text-gray-300">Evidence</label>{newReport.image && (<button type="button" onClick={analyzeImageWithGemini} disabled={isAnalyzingImage} className="text-xs bg-purple-600/20 text-purple-300 border border-purple-500/50 px-3 py-1 rounded-full flex items-center">{isAnalyzingImage ? "Analyzing..." : "Auto-fill with Gemini"}</button>)}</div>
                             <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center bg-gray-700/50 relative">
                                <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, setNewReport, newReport)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required />
                                {newReport.image ? <img src={newReport.image} className="h-48 w-full object-cover rounded-lg" /> : <div className="flex flex-col items-center"><Upload className="text-gray-400 mb-2" size={32} /><p className="text-gray-400 text-sm">Upload Photo</p></div>}
                             </div>
                        </div>
                        <div className="grid grid-cols-2 gap-6">
                            <div>
                                <select 
                                    className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white outline-none focus:ring-2 focus:ring-blue-500"
                                    value={newReport.state}
                                    onChange={(e) => {
                                        const val = e.target.value;
                                        setNewReport({
                                            ...newReport,
                                            state: val,
                                            district: locationData[val] ? locationData[val][0] : ''
                                        });
                                    }}
                                >
                                    {Object.keys(locationData).sort().map(state => (
                                        <option key={state} value={state}>{state}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <select 
                                    className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white outline-none focus:ring-2 focus:ring-blue-500"
                                    value={newReport.district}
                                    onChange={(e) => setNewReport({...newReport, district: e.target.value})}
                                >
                                    {locationData[newReport.state]?.map(district => (
                                        <option key={district} value={district}>{district}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        <input 
                            type="text" 
                            placeholder="Area / Locality (e.g. Indiranagar)" 
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                            value={newReport.area} 
                            onChange={(e) => setNewReport({...newReport, area: e.target.value})} 
                            required
                        />

                        <div className="relative">
                            <input 
                                type="text" 
                                list="problem-types"
                                placeholder="Type of Problem (e.g. Pothole, Broken Road)" 
                                className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                value={newReport.category} 
                                onChange={(e) => setNewReport({...newReport, category: e.target.value})} 
                                required
                            />
                            <datalist id="problem-types">
                                <option value="Pothole" />
                                <option value="Broken Road" />
                                <option value="Water Leakage" />
                                <option value="Street Light" />
                                <option value="Garbage Dump" />
                                <option value="Broken Signal" />
                                <option value="Manhole Cover" />
                            </datalist>
                        </div>

                        <input 
                            type="text" 
                            placeholder="Address or Landmark" 
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" 
                            value={newReport.location} 
                            onChange={(e) => setNewReport({...newReport, location: e.target.value})} 
                        />
                        <textarea placeholder="Description" rows="3" className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white" value={newReport.description} onChange={(e) => setNewReport({...newReport, description: e.target.value})}></textarea>
                        <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-500 transition">Submit Report</button>
                    </form>
                  </div>
                )}

                {activeTab === 'stats' && (
                  <div className="space-y-8">
                     <div className="flex justify-between"><h2 className="text-3xl font-bold text-white">Analytics</h2><button onClick={generateInsightsWithGemini} disabled={isGeneratingSummary} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">{isGeneratingSummary ? "..." : "Generate Insights"}</button></div>
                     {aiSummary && <div className="bg-purple-900/20 border border-purple-500/30 p-6 rounded-2xl">{aiSummary}</div>}
                     <div className="grid md:grid-cols-2 gap-4">
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                             <h3 className="text-gray-400 mb-4">Top Issues</h3>
                             {stats.sortedCategories.slice(0,5).map(([cat, count], i) => (
                                 <div key={i} className="flex justify-between py-2 border-b border-gray-700 last:border-0"><span>{cat}</span><span className="font-bold text-white">{count}</span></div>
                             ))}
                        </div>
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                             <h3 className="text-gray-400 mb-4">State Performance</h3>
                             {stats.stateRankings.slice(0,5).map((s, i) => (
                                 <div key={i} className="flex justify-between py-2 border-b border-gray-700 last:border-0"><span>{s.name}</span><span className={s.ratio < 50 ? "text-red-400 font-bold" : "text-green-400 font-bold"}>{Math.round(s.ratio)}%</span></div>
                             ))}
                        </div>
                     </div>
                     
                     {/* New Graph Visualization */}
                     <TrendChart />
                  </div>
                )}

                {activeTab === 'feed' && (
                  <div>
                    <h2 className="text-3xl font-bold text-white mb-8">Public Dashboard</h2>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {reports.slice(0, visibleCount).map((report) => <FeedCard key={report.id} report={report} onUpvote={handleUpvote} />)}
                    </div>
                    {visibleCount < reports.length && <button onClick={() => setVisibleCount(p => p+9)} className="block mx-auto mt-8 text-blue-400">Load More</button>}
                  </div>
                )}

                {activeTab === 'admin' && (
                  <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-white">Official Portal</h2>
                        <div className="flex bg-gray-800 rounded-lg p-1 border border-gray-700">
                            <button 
                                onClick={() => setAdminSortBy('date')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition ${adminSortBy === 'date' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}
                            >
                                Newest
                            </button>
                            <button 
                                onClick={() => setAdminSortBy('upvotes')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition ${adminSortBy === 'upvotes' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}
                            >
                                Most Critical
                            </button>
                        </div>
                    </div>

                    <div className="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-x-auto">
                        <table className="w-full text-left">
                            <thead><tr className="bg-gray-900 text-gray-400"><th className="p-4">ID</th><th className="p-4">Location & Date</th><th className="p-4">Type</th><th className="p-4">Upvotes</th><th className="p-4">Status</th><th className="p-4">Action</th></tr></thead>
                            <tbody className="divide-y divide-gray-700">
                                {reports
                                    .slice() // create copy to sort
                                    .sort((a, b) => {
                                        if (adminSortBy === 'upvotes') {
                                            return b.upvotes - a.upvotes;
                                        } else {
                                            // Default date sort (assuming createdAt exists or fallback)
                                            const tA = a.createdAt?.seconds || 0;
                                            const tB = b.createdAt?.seconds || 0;
                                            return tB - tA;
                                        }
                                    })
                                    .slice(0, adminVisibleCount)
                                    .map((r) => <AdminRow key={r.id} report={r} onStatusUpdate={updateStatus} onVerifyStart={setResolvingId} formatDate={formatDate} />)}
                            </tbody>
                        </table>
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SmartRoadMonitoring />);
    </script>
</body>
</html>
