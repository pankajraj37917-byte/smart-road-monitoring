import React, { useState, useMemo, useEffect, useCallback } from 'react';
import { Camera, MapPin, Send, AlertTriangle, CheckCircle, Clock, ThumbsUp, MessageSquare, X, Upload, BarChart2, Activity, Hash, ChevronRight, Eye, Check, Trophy, Star, TrendingUp, AlertOctagon, Landmark, Navigation, Globe, Map, Sparkles, FileText, List, ChevronDown } from 'lucide-react';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  onSnapshot, 
  serverTimestamp
} from 'firebase/firestore';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Static Data (Moved outside component for performance) ---
const locationData = {
    "Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Sri Potti Sriramulu Nellore", "Visakhapatnam", "Vizianagaram", "West Godavari", "YSR District, Kadapa (Cuddapah)"],
    "Arunachal Pradesh": ["Anjaw", "Changlang", "Dibang Valley", "East Kameng", "East Siang", "Kamle", "Kra Daadi", "Kurung Kumey", "Lepa Rada", "Lohit", "Longding", "Lower Dibang Valley", "Lower Siang", "Lower Subansiri", "Namsai", "Pakke Kessang", "Papum Pare", "Shi Yomi", "Siang", "Tawang", "Tirap", "Upper Siang", "Upper Subansiri", "West Kameng", "West Siang"],
    "Assam": ["Baksa", "Barpeta", "Biswanath", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Hojai", "Jorhat", "Kamrup", "Kamrup Metropolitan", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Majuli", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "South Salmara-Mankachar", "Tinsukia", "Udalguri", "West Karbi Anglong"],
    "Bihar": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"],
    "Chhattisgarh": ["Balod", "Baloda Bazar", "Balrampur", "Bastar", "Bemetara", "Bijapur", "Bilaspur", "Dantewada", "Dhamtari", "Durg", "Gariaband", "Gaurela-Pendra-Marwahi", "Janjgir-Champa", "Jashpur", "Kabirdham", "Kanker", "Kondagaon", "Korba", "Koriya", "Mahasamund", "Mungeli", "Narayanpur", "Raigarh", "Raipur", "Rajnandgaon", "Sukma", "Surajpur", "Surguja"],
    "Goa": ["North Goa", "South Goa"],
    "Gujarat": ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad", "Chhota Udaipur", "Dahod", "Dang", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kheda", "Kutch", "Mahisagar", "Mehsana", "Morbi", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar", "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Vadodara", "Valsad"],
    "Haryana": ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Nuh", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"],
    "Himachal Pradesh": ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"],
    "Jharkhand": ["Bokaro", "Chatra", "Deoghar", "Dhanbad", "Dumka", "East Singhbhum", "Garhwa", "Giridih", "Godda", "Gumla", "Hazaribagh", "Jamtara", "Khunti", "Koderma", "Latehar", "Lohardaga", "Pakur", "Palamu", "Ramgarh", "Ranchi", "Sahibganj", "Seraikela-Kharsawan", "Simdega", "West Singhbhum"],
    "Karnataka": ["Bagalkot", "Bangalore Rural", "Bangalore Urban", "Belgaum", "Bellary", "Bidar", "Bijapur", "Chamarajanagar", "Chikkaballapur", "Chikmagalur", "Chitradurga", "Dakshina Kannada", "Davangere", "Dharwad", "Gadag", "Gulbarga", "Hassan", "Haveri", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysore", "Raichur", "Ramanagara", "Shimoga", "Tumkur", "Udupi", "Uttara Kannada", "Yadgir"],
    "Kerala": ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappuram", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"],
    "Madhya Pradesh": ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha"],
    "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"],
    "Manipur": ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"],
    "Meghalaya": ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills"],
    "Mizoram": ["Aizawl", "Champhai", "Hnahthial", "Khawzawl", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Saitual", "Serchhip"],
    "Nagaland": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"],
    "Odisha": ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghpur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar", "Khurda", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Subarnapur", "Sundargarh"],
    "Punjab": ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Muktsar", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar", "Sangrur", "Shahid Bhagat Singh Nagar", "Sri Muktsar Sahib", "Tarn Taran"],
    "Rajasthan": ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Bharatpur", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur"],
    "Sikkim": ["East Sikkim", "North Sikkim", "South Sikkim", "West Sikkim"],
    "Tamil Nadu": ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"],
    "Telangana": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal", "Nagarkurnool", "Nalgonda", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Rangareddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal (Rural)", "Warangal (Urban)", "Yadadri Bhuvanagiri"],
    "Tripura": ["Dhalai", "Gomati", "Khowai", "North Tripura", "Sepahijala", "South Tripura", "Unakoti", "West Tripura"],
    "Uttar Pradesh": ["Agra", "Aligarh", "Ambedkar Nagar", "Amethi", "Amroha", "Auraiya", "Ayodhya", "Azamgarh", "Baghpat", "Bahraich", "Ballia", "Balrampur", "Banda", "Barabanki", "Bareilly", "Basti", "Bhadohi", "Bijnor", "Budaun", "Bulandshahr", "Chandauli", "Chitrakoot", "Deoria", "Etah", "Etawah", "Farrukhabad", "Fatehpur", "Firozabad", "Gautam Buddha Nagar", "Ghaziabad", "Ghazipur", "Gonda", "Gorakhpur", "Hamirpur", "Hapur", "Hardoi", "Hathras", "Jalaun", "Jaunpur", "Jhansi", "Kannauj", "Kanpur Dehat", "Kanpur Nagar", "Kasganj", "Kaushambi", "Kheri", "Kushinagar", "Lalitpur", "Lucknow", "Maharajganj", "Mahoba", "Mainpuri", "Mathura", "Mau", "Meerut", "Mirzapur", "Moradabad", "Muzaffarnagar", "Pilibhit", "Pratapgarh", "Prayagraj", "Raebareli", "Rampur", "Saharanpur", "Sambhal", "Sant Kabir Nagar", "Shahjahanpur", "Shamli", "Shravasti", "Siddharthnagar", "Sitapur", "Sonbhadra", "Sultanpur", "Unnao", "Varanasi"],
    "Uttarakhand": ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragarh", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"],
    "West Bengal": ["Alipurduar", "Bankura", "Birbhum", "Cooch Behar", "Dakshin Dinajpur", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Jhargram", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Bardhaman", "Paschim Medinipur", "Purba Bardhaman", "Purba Medinipur", "Purulia", "South 24 Parganas", "Uttar Dinajpur"],
    "Andaman and Nicobar Islands": ["Nicobar", "North and Middle Andaman", "South Andaman"],
    "Chandigarh": ["Chandigarh"],
    "Dadra and Nagar Haveli and Daman and Diu": ["Dadra and Nagar Haveli", "Daman", "Diu"],
    "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"],
    "Jammu and Kashmir": ["Anantnag", "Bandipora", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"],
    "Ladakh": ["Kargil", "Leh"],
    "Lakshadweep": ["Lakshadweep"],
    "Puducherry": ["Karaikal", "Mahe", "Puducherry", "Yanam"]
};

const stateGovtMap = {
    "Karnataka": { party: "People's Progressive Party", color: "text-green-400" },
    "Maharashtra": { party: "United Alliance Front", color: "text-orange-400" },
    "Delhi": { party: "Capital Care Party", color: "text-blue-400" },
    "Tamil Nadu": { party: "Southern League", color: "text-yellow-400" },
    "Uttar Pradesh": { party: "Janata Vikas", color: "text-red-400" },
    "Kerala": { party: "Left Democratic Front", color: "text-red-500" },
    "West Bengal": { party: "Trinamool Congress", color: "text-green-500" },
    "Gujarat": { party: "Bharatiya Janata Party", color: "text-orange-500" },
    "Rajasthan": { party: "Indian National Congress", color: "text-blue-500" },
    "Telangana": { party: "Bharat Rashtra Samithi", color: "text-pink-400" },
    "Bihar": { party: "Janata Dal (United)", color: "text-green-300" },
    "Punjab": { party: "Aam Aadmi Party", color: "text-blue-300" }
};

// --- Optimizations: Memoized Components ---

const ProgressBar = React.memo(({ status }) => {
    const steps = ['Reported', 'In Progress', 'Resolved'];
    const currentStep = status === 'Pending' ? 0 : status === 'In Progress' ? 1 : 2;

    return (
      <div className="w-full mt-4">
        <div className="flex justify-between mb-2">
          {steps.map((step, index) => (
            <div key={step} className={`text-xs font-semibold ${index <= currentStep ? 'text-blue-400' : 'text-gray-600'}`}>
              {step}
            </div>
          ))}
        </div>
        <div className="h-2 bg-gray-700 rounded-full overflow-hidden flex">
          {steps.map((step, index) => (
            <div 
              key={index} 
              className={`h-full flex-1 border-r border-gray-800 last:border-0 transition-all duration-500 ${
                index <= currentStep ? (index === 2 ? 'bg-green-500' : 'bg-blue-500') : 'bg-gray-700'
              }`} 
            />
          ))}
        </div>
      </div>
    );
});

// Memoized Feed Card to prevent re-rendering entire list
const FeedCard = React.memo(({ report, onUpvote }) => {
  return (
    <div className="bg-gray-800 rounded-2xl shadow-lg border border-gray-700 overflow-hidden flex flex-col">
      {/* Card Header with ID */}
      <div className="px-6 py-3 bg-gray-750 border-b border-gray-700 flex justify-between items-center">
         <span className="bg-gray-900 text-gray-400 text-xs font-mono py-1 px-2 rounded border border-gray-700 flex items-center">
           <Hash size={10} className="mr-1"/> {report.id}
         </span>
         <div className="text-right">
           <span className="text-xs text-white block font-bold">{report.district}</span>
           <span className="text-xs text-gray-500 block">{report.state}</span>
         </div>
      </div>

      {/* Image Display - Split if Resolved */}
      <div className="h-48 relative overflow-hidden group bg-gray-900">
        {report.status === 'Resolved' && report.proofImage ? (
          <div className="flex h-full w-full">
            <div className="w-1/2 relative border-r border-white/20">
              <img src={report.image} className="w-full h-full object-cover" alt="Before" loading="lazy" />
              <div className="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded">BEFORE</div>
            </div>
            <div className="w-1/2 relative">
              <img src={report.proofImage} className="w-full h-full object-cover" alt="After" loading="lazy" />
              <div className="absolute top-2 left-2 bg-green-600 text-white text-[10px] px-2 py-1 rounded font-bold">FIXED</div>
            </div>
          </div>
        ) : (
          <img 
            src={report.image} 
            alt="Report" 
            className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition duration-500"
            loading="lazy"
          />
        )}
        
        {report.status !== 'Resolved' && (
           <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-gray-900 to-transparent p-4">
              <span className="text-white font-bold text-lg drop-shadow-md">{report.category}</span>
           </div>
        )}
      </div>
      
      <div className="p-6 flex-1 flex flex-col">
        <h3 className="font-semibold text-gray-200 mb-1 flex items-center justify-between">
          <span className="truncate pr-2">{report.area}</span>
          {report.coordinates && (
            <a 
              href={`https://www.google.com/maps/search/?api=1&query=${report.coordinates.lat},${report.coordinates.lng}`} 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-500 hover:text-blue-400 bg-blue-900/30 p-1.5 rounded-lg transition"
              title="View Exact Location on Maps"
            >
              <MapPin size={16} />
            </a>
          )}
        </h3>
        <p className="text-gray-400 text-sm mb-4 line-clamp-2">
          {report.description}
        </p>
        
        {/* Progress Bar Visualization */}
        <div className="mt-auto">
          <ProgressBar status={report.status} />
        </div>
        
        <div className="pt-4 mt-4 border-t border-gray-700 flex items-center justify-between">
          <button 
            // FIX: Use firestoreId (internal) instead of id (display)
            onClick={() => onUpvote(report.firestoreId, report.upvotes)}
            className="flex items-center space-x-2 text-gray-400 hover:text-blue-400 transition"
          >
            <ThumbsUp size={18} />
            <span className="text-sm font-medium">{report.upvotes}</span>
          </button>
          <span className="text-xs text-gray-500 flex items-center">
            <Clock size={12} className="mr-1" /> {report.timestamp}
          </span>
        </div>
      </div>
    </div>
  );
});

// Memoized Admin Row
const AdminRow = React.memo(({ report, onStatusUpdate, onVerifyStart }) => {
  return (
    <tr className="hover:bg-gray-750 transition">
      <td className="p-4 font-mono text-blue-400 text-sm">{report.id}</td>
      <td className="p-4">
        <div className="text-gray-300 font-bold text-sm">{report.district}</div>
        <div className="text-gray-500 text-xs">{report.state}</div>
      </td>
      <td className="p-4 text-gray-300">{report.category}</td>
      <td className="p-4">
        <div className="flex items-center text-orange-500 font-bold">
          <Activity size={14} className="mr-1" />
          {report.upvotes}
        </div>
      </td>
      <td className="p-4">
         <span className={`px-2 py-1 rounded-full text-xs border ${
          report.status === 'Resolved' ? 'bg-green-900/30 text-green-400 border-green-800' :
          report.status === 'In Progress' ? 'bg-yellow-900/30 text-yellow-400 border-yellow-800' :
          'bg-red-900/30 text-red-400 border-red-800'
        }`}>
          {report.status}
        </span>
      </td>
      <td className="p-4">
        <div className="flex space-x-2">
          {report.status === 'Resolved' ? (
             <span className="flex items-center text-green-500 text-xs font-bold">
               <CheckCircle size={14} className="mr-1" /> Verified
             </span>
          ) : (
            <>
              <button 
                // FIX: Use firestoreId for updates
                onClick={() => onStatusUpdate(report.firestoreId, 'In Progress')}
                className="text-gray-400 hover:text-white border border-gray-600 px-3 py-1 rounded text-xs transition"
                disabled={report.status === 'In Progress'}
              >
                Accept
              </button>
              <button 
                // FIX: Use firestoreId for verification
                onClick={() => onVerifyStart(report.firestoreId)}
                className="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-500 flex items-center shadow-lg shadow-green-900/20"
              >
                <Upload size={12} className="mr-1" /> Verify & Close
              </button>
            </>
          )}
        </div>
      </td>
    </tr>
  );
});


// Helper: Compress Image to Base64 (max 600px width, 0.7 quality)
const compressImage = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 600;
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL(file.type, 0.7)); 
      };
      img.onerror = (error) => reject(error);
    };
    reader.onerror = (error) => reject(error);
  });
};

const SmartRoadMonitoring = () => {
  const [activeTab, setActiveTab] = useState('home'); 
  const apiKey = ""; 

  // User Auth State
  const [user, setUser] = useState(null);

  // Data State
  const [reports, setReports] = useState([]);
  const [loadingData, setLoadingData] = useState(true);

  // Pagination State
  const [visibleCount, setVisibleCount] = useState(9);
  const [adminVisibleCount, setAdminVisibleCount] = useState(20);

  // --- Auth & Data Effects ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed", error);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Fetch Reports from Firestore
  useEffect(() => {
    if (!user) return;

    // RULE 1: Strict Path to Public Data
    const reportsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
    
    // RULE 2: No Complex Queries (Fetch all, sort in memory)
    const unsubscribe = onSnapshot(reportsCollection, (snapshot) => {
      const fetchedReports = snapshot.docs.map(doc => ({
        ...doc.data(),
        firestoreId: doc.id // FIX: Store the actual DB key separately from the display ID
      }));
      
      // Sort in memory by timestamp descending
      fetchedReports.sort((a, b) => {
        const tA = a.createdAt?.seconds || 0;
        const tB = b.createdAt?.seconds || 0;
        return tB - tA;
      });

      setReports(fetchedReports);
      setLoadingData(false);
    }, (error) => {
      console.error("Error fetching reports:", error);
      setLoadingData(false);
    });

    return () => unsubscribe();
  }, [user]);

  // Reset pagination when tab changes
  useEffect(() => {
    setVisibleCount(9);
    setAdminVisibleCount(20);
  }, [activeTab]);


  // State for the Admin "Proof of Fix" Modal
  const [resolvingId, setResolvingId] = useState(null);
  const [proofImage, setProofImage] = useState(null); 
  
  
  // Manual Entry States
  const [isManualState, setIsManualState] = useState(false);
  const [isManualDistrict, setIsManualDistrict] = useState(false);

  // AI States
  const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
  const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
  const [imageBase64, setImageBase64] = useState(null);
  const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);
  const [aiSummary, setAiSummary] = useState(null);

  // Analytics Logic - Memoized
  const stats = useMemo(() => {
    const areaCounts = {};
    const categoryCounts = {};
    const districtStats = {};
    const stateStats = {};

    reports.forEach(r => {
      // Basic counts
      areaCounts[r.area] = (areaCounts[r.area] || 0) + 1;
      categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;

      // District Ranking Logic
      const districtKey = `${r.district}, ${r.state}`;
      if (!districtStats[districtKey]) {
        districtStats[districtKey] = { name: r.district, state: r.state, total: 0, resolved: 0 };
      }
      districtStats[districtKey].total += 1;
      
      // State Ranking Logic
      if (!stateStats[r.state]) {
        stateStats[r.state] = { name: r.state, total: 0, resolved: 0 };
      }
      stateStats[r.state].total += 1;

      if (r.status === 'Resolved') {
        districtStats[districtKey].resolved += 1;
        stateStats[r.state].resolved += 1;
      }
    });

    const sortedAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]);
    const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);

    const districtRankings = Object.values(districtStats).map(d => ({
      ...d,
      ratio: d.total > 0 ? (d.resolved / d.total) * 100 : 0
    })).sort((a, b) => b.ratio - a.ratio); 

    const stateRankings = Object.values(stateStats).map(state => ({
      ...state,
      ratio: state.total > 0 ? (state.resolved / state.total) * 100 : 0,
      govt: stateGovtMap[state.name] || { party: "Independent", color: "text-gray-400" }
    })).sort((a, b) => b.ratio - a.ratio);

    return { sortedAreas, sortedCategories, districtRankings, stateRankings };
  }, [reports]);

  // Form State
  const [newReport, setNewReport] = useState({
    state: 'Karnataka',
    district: 'Bangalore Urban',
    area: '',
    location: '',
    coordinates: null, 
    category: 'Pothole',
    description: '',
    image: null
  });

  const handleFileChange = async (e, setFunction, currentObj) => {
    const file = e.target.files[0];
    if (file) {
      try {
        const compressedBase64 = await compressImage(file);
        
        // Remove prefix for AI processing
        const rawBase64 = compressedBase64.split(',')[1];
        setImageBase64(rawBase64);
        
        // Use compressed string for state
        if (currentObj) {
           setFunction({ ...currentObj, image: compressedBase64 });
        } else {
           setFunction(compressedBase64);
        }
      } catch (err) {
        console.error("Compression error:", err);
        alert("Error processing image. Please try another.");
      }
    }
  };

  const handleStateChange = (e) => {
    const val = e.target.value;
    if (val === 'Other') {
      setIsManualState(true);
      setIsManualDistrict(true);
      setNewReport({ ...newReport, state: '', district: '' });
    } else {
      setIsManualState(false);
      setIsManualDistrict(false);
      setNewReport({
        ...newReport, 
        state: val, 
        district: locationData[val]?.[0] || '' 
      });
    }
  };

  const handleDistrictChange = (e) => {
    const val = e.target.value;
    if (val === 'Other') {
      setIsManualDistrict(true);
      setNewReport({ ...newReport, district: '' });
    } else {
      setNewReport({ ...newReport, district: val });
    }
  };

  // --- GEMINI AI INTEGRATIONS ---

  // 1. Image Analysis
  const analyzeImageWithGemini = async () => {
    if (!imageBase64) {
      alert("Please upload an image first.");
      return;
    }
    
    setIsAnalyzingImage(true);
    setAiAnalysisResult(null);

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            role: "user",
            parts: [
              { text: "Identify the road infrastructure issue in this image. Categorize it as one of: Pothole, Street Light, Road Crack, Broken Signal, Faded Markings, Damaged Manhole, Missing Signage. Provide a short, professional description for a civic complaint. Return valid JSON only with keys: 'category' and 'description'." },
              { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }
            ]
          }],
          generationConfig: {
            responseMimeType: "application/json"
          }
        })
      });

      const data = await response.json();
      const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (resultText) {
        const result = JSON.parse(resultText);
        setNewReport(prev => ({
          ...prev,
          category: result.category || prev.category,
          description: result.description || prev.description
        }));
        setAiAnalysisResult("Auto-filled by AI âœ¨");
      }
    } catch (error) {
      console.error("Gemini Analysis Error:", error);
      alert("AI analysis failed. Please enter details manually.");
    } finally {
      setIsAnalyzingImage(false);
    }
  };

  // 2. Stats Executive Summary
  const generateInsightsWithGemini = async () => {
    setIsGeneratingSummary(true);
    setAiSummary(null);

    const dataContext = `
      Top Issues: ${JSON.stringify(stats.sortedCategories.slice(0, 3))}
      State Performance: ${JSON.stringify(stats.stateRankings.map(s => ({name: s.name, ratio: s.ratio})))}
      District Performance: ${JSON.stringify(stats.districtRankings.slice(0, 3).map(d => ({name: d.name, ratio: d.ratio})))}
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: `Act as a civic data analyst. Analyze this road issue data: ${dataContext}. Write a 3-bullet point executive summary for the City Commissioner highlighting key achievements and critical areas needing attention. Use emojis.` }]
          }]
        })
      });

      const data = await response.json();
      const summary = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiSummary(summary);
    } catch (error) {
      console.error("Gemini Summary Error:", error);
      alert("Could not generate summary.");
    } finally {
      setIsGeneratingSummary(false);
    }
  };


  const generateUniqueId = () => {
    return `WRD-${Math.floor(Math.random() * 90) + 10}-${Math.floor(Math.random() * 9000) + 1000}`;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) {
      alert("Initializing database connection. Please try again in a moment.");
      return;
    }

    const report = {
      id: generateUniqueId(), // For display ID
      state: newReport.state || "Unknown",
      district: newReport.district || "Unknown",
      area: newReport.area,
      location: newReport.location,
      coordinates: newReport.coordinates,
      category: newReport.category,
      description: newReport.description,
      status: "Pending",
      upvotes: 0,
      createdAt: serverTimestamp(),
      timestamp: "Just now", // UI placeholder until refreshed
      image: newReport.image || "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
      proofImage: null,
      comments: []
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), report);
      
      // Reset form
      setNewReport({ state: 'Karnataka', district: 'Bangalore Urban', area: '', location: '', coordinates: null, category: 'Pothole', description: '', image: null });
      setActiveTab('feed');
    } catch (err) {
      console.error("Error saving report:", err);
      alert("Failed to submit report. Please check your connection.");
    }
  };

  // Memoized handlers to avoid re-creating them on every render
  const updateStatus = useCallback(async (docId, newStatus) => {
    if (!docId || !user) return;
    try {
      // FIX: Ensure docId passed here is the firestoreId
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', docId);
      await updateDoc(docRef, { status: newStatus });
    } catch (err) {
      console.error("Update failed", err);
    }
  }, [user]);

  const submitResolution = async () => {
    if (!proofImage) {
      alert("Please upload a photo of the fixed road.");
      return;
    }
    if (!resolvingId || !user) return;

    try {
      // FIX: resolvingId is now the firestoreId
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', resolvingId);
      await updateDoc(docRef, { 
        status: 'Resolved', 
        proofImage: proofImage 
      });
      setResolvingId(null);
      setProofImage(null);
    } catch (err) {
      console.error("Resolution submit failed", err);
    }
  };

  const handleUpvote = useCallback(async (docId, currentUpvotes) => {
    if (!docId || !user) return;
    try {
      // FIX: Ensure docId passed here is the firestoreId
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', docId);
      await updateDoc(docRef, { upvotes: currentUpvotes + 1 });
    } catch (err) {
      console.error("Upvote failed", err);
    }
  }, [user]);

  return (
    <div className="min-h-screen bg-gray-900 font-sans text-gray-100">
      
      {/* Proof of Fix Modal */}
      {resolvingId && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
          <div className="bg-gray-800 rounded-2xl w-full max-w-md p-6 border border-gray-700 shadow-2xl">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-white">Close Ticket</h3>
              <button onClick={() => {setResolvingId(null); setProofImage(null);}} className="text-gray-400 hover:text-white">
                <X />
              </button>
            </div>
            
            <p className="text-gray-400 mb-4 text-sm">
              To verify this resolution, you <span className="text-red-400 font-bold">must</span> upload a photo of the completed work.
            </p>

            <div className="space-y-4">
              <div className="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center bg-gray-700/50 relative">
                <input 
                  type="file" 
                  accept="image/*"
                  onChange={(e) => handleFileChange(e, setProofImage, null)}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                {proofImage ? (
                  <img src={proofImage} alt="Proof" className="h-40 w-full object-cover rounded-lg mx-auto" />
                ) : (
                  <div className="flex flex-col items-center">
                    <Upload className="text-blue-400 mb-2" size={32} />
                    <p className="text-blue-300 font-medium">Upload Proof of Fix</p>
                  </div>
                )}
              </div>
              
              <button 
                onClick={submitResolution}
                className={`w-full py-3 rounded-xl font-bold transition ${proofImage ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}
                disabled={!proofImage}
              >
                Verify & Close Complaint
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Navigation */}
      <nav className="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <div className="flex items-center cursor-pointer" onClick={() => setActiveTab('home')}>
              <div className="bg-blue-600 p-2 rounded-lg mr-2">
                <MapPin className="text-white" size={24} />
              </div>
              <span className="font-bold text-xl tracking-tight text-white">CivicFix</span>
            </div>
            
            {/* Desktop Menu */}
            <div className="hidden md:flex space-x-8">
              {['home', 'feed', 'stats', 'admin'].map((tab) => (
                <button 
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`capitalize ${activeTab === tab ? 'text-blue-400 font-bold' : 'text-gray-400 hover:text-white transition'}`}
                >
                  {tab === 'feed' ? 'Dashboard' : tab === 'stats' ? 'Analytics' : tab === 'admin' ? 'Official' : tab}
                </button>
              ))}
            </div>
            
            <button 
              onClick={() => setActiveTab('report')}
              className="bg-blue-600 text-white px-5 py-2 rounded-full font-medium shadow-lg hover:bg-blue-500 transition transform hover:-translate-y-0.5 flex items-center"
            >
              <Camera size={18} className="mr-2" /> Report Issue
            </button>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {/* Loading Spinner */}
        {loadingData && activeTab !== 'home' && reports.length === 0 && (
          <div className="flex justify-center py-10">
            <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
          </div>
        )}

        {/* HOME VIEW */}
        {activeTab === 'home' && (
          <div className="space-y-16">
            <section className="text-center py-20 px-4">
              <h1 className="text-5xl font-extrabold text-white mb-6 leading-tight">
                CivicFix <br/>
                <span className="text-blue-500">Smoother Journeys.</span>
              </h1>
              
              {/* Inspirational Quote Section */}
              <div className="max-w-3xl mx-auto mb-10 bg-gradient-to-r from-blue-900/40 to-purple-900/40 border border-blue-500/30 p-6 rounded-2xl backdrop-blur-sm">
                <p className="text-2xl font-serif italic text-blue-200 mb-2">
                  "Your shutter can save a life."
                </p>
                <p className="text-lg text-gray-300 font-medium">
                  One Photo = One Accident Less.
                </p>
              </div>

              <p className="max-w-2xl mx-auto text-xl text-gray-400 mb-10">
                A transparent, public ledger for road infrastructure issues. Reports are saved permanently to the civic database.
              </p>
              <div className="flex justify-center gap-4">
                <button 
                  onClick={() => setActiveTab('report')}
                  className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/50 hover:bg-blue-500 transition"
                >
                  File Complaint
                </button>
                <button 
                  onClick={() => setActiveTab('stats')}
                  className="bg-gray-800 text-white border border-gray-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-700 transition"
                >
                  View Graphs
                </button>
              </div>
            </section>
            
            {/* Quick Stats Teaser */}
            <div className="grid md:grid-cols-3 gap-6">
              <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-gray-400 font-medium">Top Star District</h3>
                  <Star className="text-yellow-400 fill-yellow-400" />
                </div>
                <p className="text-3xl font-bold text-white">
                  {stats.districtRankings[0]?.name || "N/A"}
                </p>
                <p className="text-sm text-green-400 mt-2">
                  {Math.round(stats.districtRankings[0]?.ratio || 0)}% Efficiency
                </p>
              </div>
              <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-gray-400 font-medium">Top Road Issue</h3>
                  <AlertTriangle className="text-yellow-500" />
                </div>
                <p className="text-3xl font-bold text-white">{stats.sortedCategories[0]?.[0] || "N/A"}</p>
                <p className="text-sm text-yellow-400 mt-2">Needs Urgent Attention</p>
              </div>
              <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-gray-400 font-medium">Underperforming State</h3>
                  <AlertOctagon className="text-red-500" />
                </div>
                <p className="text-3xl font-bold text-white">
                  {stats.stateRankings[stats.stateRankings.length - 1]?.name || "N/A"}
                </p>
                <p className="text-sm text-red-400 mt-2">
                  Action Required
                </p>
              </div>
            </div>
          </div>
        )}

        {/* REPORT VIEW */}
        {activeTab === 'report' && (
          <div className="max-w-2xl mx-auto">
            <div className="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-hidden">
              <div className="bg-blue-600 p-6 text-white">
                <h2 className="text-2xl font-bold flex items-center">
                  <AlertTriangle className="mr-3" /> New Road Report
                </h2>
                <p className="text-blue-100 mt-2">Your ID will be generated upon submission.</p>
              </div>
              
              <form onSubmit={handleSubmit} className="p-8 space-y-6">
                
                {/* State and District Selection */}
                <div className="grid grid-cols-2 gap-6">
                   <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">State</label>
                    {isManualState ? (
                       <input 
                       type="text"
                       placeholder="Enter State Name"
                       className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                       value={newReport.state}
                       onChange={(e) => setNewReport({...newReport, state: e.target.value})}
                     />
                    ) : (
                      <select 
                        className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        value={newReport.state}
                        onChange={handleStateChange}
                      >
                        {Object.keys(locationData).map(state => (
                          <option key={state} value={state}>{state}</option>
                        ))}
                        <option value="Other">Other (Type Manually)</option>
                      </select>
                    )}
                  </div>
                   <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">District</label>
                    {isManualDistrict ? (
                       <div className="relative">
                         <input 
                           type="text"
                           placeholder="Enter District Name"
                           className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                           value={newReport.district}
                           onChange={(e) => setNewReport({...newReport, district: e.target.value})}
                         />
                         {!isManualState && (
                           <button 
                             type="button" 
                             onClick={() => { setIsManualDistrict(false); setNewReport(prev => ({...prev, district: locationData[newReport.state]?.[0] || ''})); }}
                             className="absolute right-3 top-3.5 text-xs text-blue-400 hover:text-blue-300 flex items-center"
                           >
                             <List size={12} className="mr-1" /> Select List
                           </button>
                         )}
                       </div>
                    ) : (
                      <select 
                        className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        value={newReport.district}
                        onChange={handleDistrictChange}
                      >
                        {locationData[newReport.state]?.map(district => (
                          <option key={district} value={district}>{district}</option>
                        ))}
                        <option value="Other">Other (Type Manually)</option>
                      </select>
                    )}
                  </div>
                </div>

                <div className="space-y-4">
                  <label className="block text-sm font-medium text-gray-300">Detailed Location</label>
                  
                  {/* Manual Input Only */}
                  <div className="relative">
                    <input 
                      type="text" 
                      placeholder="Street name, landmark (e.g., Near Main Market)"
                      className="w-full p-3 pl-10 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newReport.location}
                      onChange={(e) => setNewReport({...newReport, location: e.target.value})}
                      required
                    />
                    <Map className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                  </div>
                </div>
                
                 {/* Image Upload Area with AI Integration */}
                 <div className="space-y-2">
                  <div className="flex justify-between items-center">
                     <label className="block text-sm font-medium text-gray-300">Evidence</label>
                     {/* Gemini AI Button */}
                     {newReport.image && (
                       <button
                         type="button"
                         onClick={analyzeImageWithGemini}
                         disabled={isAnalyzingImage}
                         className="text-xs bg-purple-600/20 text-purple-300 border border-purple-500/50 px-3 py-1 rounded-full flex items-center hover:bg-purple-600/30 transition disabled:opacity-50"
                       >
                         {isAnalyzingImage ? (
                           <>Analyzing... <div className="ml-2 w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin" /></>
                         ) : (
                           <><Sparkles className="w-3 h-3 mr-1.5" /> Auto-fill with Gemini</>
                         )}
                       </button>
                     )}
                  </div>
                  
                  <div className={`border-2 border-dashed ${aiAnalysisResult ? 'border-purple-500 bg-purple-900/10' : 'border-gray-600 bg-gray-700/50'} rounded-xl p-8 text-center hover:bg-gray-750 transition cursor-pointer relative`}>
                    <input 
                      type="file" 
                      accept="image/*"
                      onChange={(e) => handleFileChange(e, setNewReport, newReport)}
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                      required
                    />
                    {newReport.image ? (
                      <div className="relative h-48 w-full group">
                        <img src={newReport.image} alt="Preview" className="h-full w-full object-cover rounded-lg" />
                         {aiAnalysisResult && (
                           <div className="absolute bottom-2 right-2 bg-purple-600 text-white text-xs px-2 py-1 rounded shadow-lg flex items-center animate-pulse">
                             <Sparkles className="w-3 h-3 mr-1" /> AI Analyzed
                           </div>
                         )}
                      </div>
                    ) : (
                      <div className="flex flex-col items-center">
                        <Upload className="text-gray-400 mb-2" size={32} />
                        <p className="text-gray-400 text-sm">Upload Photo</p>
                      </div>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">Area / Town</label>
                    <input 
                      type="text"
                      placeholder="e.g. Indiranagar"
                      className="w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none"
                      value={newReport.area}
                      onChange={(e) => setNewReport({...newReport, area: e.target.value})}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-300">Problem Type {aiAnalysisResult && <span className="text-purple-400 text-xs">(AI Suggested)</span>}</label>
                    <select 
                      className={`w-full p-3 bg-gray-700 border ${aiAnalysisResult ? 'border-purple-500 ring-1 ring-purple-500' : 'border-gray-600'} rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all`}
                      value={newReport.category}
                      onChange={(e) => setNewReport({...newReport, category: e.target.value})}
                    >
                      <option>Pothole</option>
                      <option>Street Light</option>
                      <option>Road Crack</option>
                      <option>Broken Signal</option>
                      <option>Faded Markings</option>
                      <option>Damaged Manhole</option>
                      <option>Missing Signage</option>
                    </select>
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="block text-sm font-medium text-gray-300">Description {aiAnalysisResult && <span className="text-purple-400 text-xs">(AI Generated)</span>}</label>
                  <textarea 
                    placeholder="Describe the road issue..."
                    rows="4"
                    className={`w-full p-3 bg-gray-700 border ${aiAnalysisResult ? 'border-purple-500 ring-1 ring-purple-500' : 'border-gray-600'} rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all`}
                    value={newReport.description}
                    onChange={(e) => setNewReport({...newReport, description: e.target.value})}
                    required
                  ></textarea>
                </div>

                <button 
                  type="submit" 
                  disabled={!user}
                  className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-500 shadow-lg transition disabled:bg-gray-700 disabled:text-gray-500"
                >
                  {user ? "Generate Official Report" : "Connecting to Database..."}
                </button>
              </form>
            </div>
          </div>
        )}

        {/* ANALYTICS/STATS VIEW - GRAPH UPDATE */}
        {activeTab === 'stats' && (
          <div className="space-y-8">
            <div className="flex justify-between items-center">
              <h2 className="text-3xl font-bold text-white flex items-center">
                <BarChart2 className="mr-3 text-blue-500" /> Graphical Analysis
              </h2>
              <button 
                onClick={generateInsightsWithGemini}
                disabled={isGeneratingSummary}
                className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-medium flex items-center shadow-lg shadow-purple-900/50 transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isGeneratingSummary ? (
                   <><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" /> Generating...</>
                ) : (
                   <><Sparkles className="w-4 h-4 mr-2" /> Generate AI Insights</>
                )}
              </button>
            </div>

            {/* AI SUMMARY CARD */}
            {aiSummary && (
              <div className="bg-gradient-to-r from-purple-900/40 to-blue-900/40 border border-purple-500/30 p-6 rounded-2xl animate-in fade-in slide-in-from-top-4">
                <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                  <FileText className="mr-2 text-purple-400" /> Commissioner's Executive Summary
                </h3>
                <div className="prose prose-invert max-w-none text-gray-300 whitespace-pre-line">
                  {aiSummary}
                </div>
              </div>
            )}
            
             {/* New State Governance Report Card */}
             <div className="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl">
               <h3 className="text-2xl font-bold text-white mb-6 flex items-center">
                 <Landmark className="mr-3 text-purple-500" /> State Governance Tracker
                 <span className="ml-3 text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded-full border border-purple-500/30">
                   Resolution Efficiency by Ruling Government
                 </span>
               </h3>

               <div className="grid grid-cols-1 gap-4">
                 {stats.stateRankings.map((state, index) => {
                   const isCritical = state.ratio < 50;
                   return (
                     <div key={state.name} className={`p-5 rounded-xl border transition flex flex-col md:flex-row items-center justify-between ${isCritical ? 'bg-red-900/10 border-red-500/50' : 'bg-gray-700/30 border-gray-700'}`}>
                       
                       <div className="flex items-center mb-4 md:mb-0 w-full md:w-1/3">
                         <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg mr-4 bg-gray-700 text-gray-300`}>
                           {index + 1}
                         </div>
                         <div>
                           <h4 className="font-bold text-lg text-white">{state.name}</h4>
                           <p className={`text-sm font-semibold ${state.govt.color}`}>{state.govt.party}</p>
                         </div>
                       </div>

                       {/* Status Banner */}
                       <div className="w-full md:w-1/3 flex justify-center mb-4 md:mb-0">
                          {isCritical ? (
                            <div className="bg-red-500/20 border border-red-500 text-red-400 px-4 py-2 rounded-lg flex items-center animate-pulse">
                              <AlertOctagon size={18} className="mr-2" />
                              <span className="font-bold">CRITICAL: Underperforming</span>
                            </div>
                          ) : (
                            <div className="bg-green-500/20 border border-green-500 text-green-400 px-4 py-2 rounded-lg flex items-center">
                              <CheckCircle size={18} className="mr-2" />
                              <span className="font-bold">Active & Responsive</span>
                            </div>
                          )}
                       </div>

                       {/* Stats */}
                       <div className="text-right w-full md:w-1/3">
                          <span className="text-3xl font-bold text-white">{Math.round(state.ratio)}%</span>
                          <span className="text-xs text-gray-400 block">Resolution Rate</span>
                       </div>
                     </div>
                   );
                 })}
               </div>
            </div>

            {/* Existing Star District Leaderboard */}
            <div className="bg-gradient-to-br from-gray-800 to-gray-900 p-8 rounded-2xl border border-gray-700 shadow-xl relative overflow-hidden">
               <div className="absolute top-0 right-0 p-8 opacity-10">
                 <Trophy size={200} className="text-yellow-500" />
               </div>
               
               <h3 className="text-2xl font-bold text-white mb-6 flex items-center relative z-10">
                 <Trophy className="mr-3 text-yellow-500" /> National District Leaderboard
               </h3>

               <div className="space-y-6 relative z-10">
                 {stats.districtRankings.slice(0, 5).map((dist, index) => (
                   <div key={dist.name} className={`p-4 rounded-xl border transition flex items-center ${index === 0 ? 'bg-yellow-900/10 border-yellow-500/50' : 'bg-gray-800/50 border-gray-700'}`}>
                     <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl mr-4 ${
                       index === 0 ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/50' : 
                       index === 1 ? 'bg-gray-400 text-black' : 
                       index === 2 ? 'bg-orange-700 text-white' : 'bg-gray-700 text-gray-400'
                     }`}>
                       {index + 1}
                     </div>
                     
                     <div className="flex-1">
                       <div className="flex justify-between items-end mb-2">
                         <h4 className={`font-bold text-lg ${index === 0 ? 'text-yellow-400' : 'text-gray-200'}`}>
                           {dist.name} <span className="text-xs font-normal text-gray-500 ml-2">({dist.state})</span> {index === 0 && <Star className="inline h-4 w-4 fill-yellow-400 ml-1" />}
                         </h4>
                         <div className="text-right">
                           <span className="text-2xl font-bold text-white">{Math.round(dist.ratio)}%</span>
                           <span className="text-xs text-gray-400 block">Efficiency</span>
                         </div>
                       </div>
                       
                       {/* Progress Bar */}
                       <div className="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                         <div 
                           className={`h-full rounded-full transition-all duration-1000 ${
                             index === 0 ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : 
                             'bg-blue-600'
                           }`} 
                           style={{ width: `${dist.ratio}%` }}
                         ></div>
                       </div>
                     </div>
                   </div>
                 ))}
               </div>
            </div>
            
            <div className="grid md:grid-cols-3 gap-6">
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                   <p className="text-gray-400 mb-2">Total Reports</p>
                   <p className="text-4xl font-bold text-white">{reports.length}</p>
                </div>
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                   <p className="text-gray-400 mb-2">Pending</p>
                   <p className="text-4xl font-bold text-red-500">{reports.filter(r => r.status === 'Pending').length}</p>
                </div>
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center">
                   <p className="text-gray-400 mb-2">Verified Fixed</p>
                   <p className="text-4xl font-bold text-green-500">{reports.filter(r => r.status === 'Resolved').length}</p>
                </div>
            </div>
          </div>
        )}

        {/* FEED VIEW (OPTIMIZED) */}
        {activeTab === 'feed' && (
          <div>
            <h2 className="text-3xl font-bold text-white mb-8">Public Dashboard</h2>

            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
              {reports.slice(0, visibleCount).map((report) => (
                <FeedCard key={report.id} report={report} onUpvote={handleUpvote} />
              ))}
            </div>
            
            {/* Load More Button */}
            {visibleCount < reports.length && (
              <div className="flex justify-center mt-10">
                <button 
                  onClick={() => setVisibleCount(prev => prev + 9)}
                  className="bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 px-6 py-3 rounded-full flex items-center transition"
                >
                  Load More Reports <ChevronDown className="ml-2" />
                </button>
              </div>
            )}
          </div>
        )}

        {/* ADMIN VIEW (OPTIMIZED) */}
        {activeTab === 'admin' && (
          <div className="bg-gray-800 rounded-2xl shadow-xl border border-gray-700">
            <div className="p-6 border-b border-gray-700 flex justify-between items-center">
              <div>
                <h2 className="text-xl font-bold text-white">Official Portal</h2>
                <p className="text-sm text-gray-400">Department of Works</p>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="bg-gray-900 border-b border-gray-700 text-xs uppercase text-gray-400 font-semibold">
                    <th className="p-4">ID</th>
                    <th className="p-4">Location</th>
                    <th className="p-4">Type</th>
                    <th className="p-4">Pressure</th>
                    <th className="p-4">Status</th>
                    <th className="p-4">Action</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-700">
                  {reports.slice(0, adminVisibleCount).map((report) => (
                    <AdminRow 
                      key={report.id} 
                      report={report} 
                      onStatusUpdate={updateStatus} 
                      onVerifyStart={setResolvingId} 
                    />
                  ))}
                </tbody>
              </table>
            </div>
            
            {/* Load More Button for Admin */}
            {adminVisibleCount < reports.length && (
              <div className="p-4 border-t border-gray-700 text-center">
                <button 
                  onClick={() => setAdminVisibleCount(prev => prev + 20)}
                  className="text-blue-400 hover:text-blue-300 text-sm font-medium"
                >
                  Load More Entries
                </button>
              </div>
            )}
          </div>
        )}

      </main>
    </div>
  );
};

export default SmartRoadMonitoring;
